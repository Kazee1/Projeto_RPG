[{"updatedAt":"2026-02-17T20:09:33.440Z","createdAt":"2026-02-12T23:37:50.687Z","id":"NTeI9lc3Cy5QgHP9","name":"My workflow","description":null,"active":true,"isArchived":false,"nodes":[{"parameters":{"method":"POST","url":"https://api.mistral.ai/v1/chat/completions","authentication":"predefinedCredentialType","nodeCredentialType":"mistralCloudApi","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.ai_request }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-2576,-800],"id":"ec7ad830-7290-4835-9b8b-7aa5eec89ba3","name":"HTTP Request1","credentials":{"mistralCloudApi":{"id":"HbOWghtcXEf7jxxj","name":"Mistral Cloud account"},"openRouterApi":{"id":"mCdp8OcIGuBAlyxd","name":"OpenRouter account"}}},{"parameters":{"httpMethod":"POST","path":"start-game","authentication":"headerAuth","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-2864,-800],"id":"3253eb8b-b254-4f4b-868b-6f7ffdffc025","name":"Webhook","webhookId":"c276927c-c353-4394-a031-8f53cdf56f8f","credentials":{"httpHeaderAuth":{"id":"vUs8rqLIlN9NCNTc","name":"Header Auth account"}}},{"parameters":{"jsCode":"// =========================================\n// GERAÃ‡ÃƒO DE AVENTURA INICIAL â€” V6.0\n// Alinhado com: Mestre Unificado V6 + Parser V6\n//\n// CORREÃ‡Ã•ES vs V5.2:\n// [1] Adiciona status_effects: [] no estado inicial\n// [2] Adiciona world_flags: [] â€” tabela consumida pelo Mestre\n// [3] Inicializa in_combat: false e combat_target: null\n// [4] NPCs gerados com tag HP: \"Nome [HP:15/15]\"\n// [5] armor_class calculado e persistido no schema\n// [6] current_summary gerado como primeiro fragmento de lore\n// [7] inventory.type alinhado: sÃ³ \"consumable\" | \"equipment\" | \"quest_item\" | \"misc\"\n// [8] Estrutura de retorno separada: ai_request (HTTP) vs metadata (interno)\n// =========================================\n\n// =========================================\n// 1. CAPTURA E VALIDAÃ‡ÃƒO DE DADOS DO WEBHOOK\n// =========================================\nconst body = $input.item.json.body || {};\n\nconst charName     = (body.character_name || \"Viajante\").trim();\nconst className    = (body.class_name     || \"Aventureiro\").trim();\nconst systemId     = body.system || \"dnd\";\nconst genres       = Array.isArray(body.genres)\n  ? body.genres.join(\", \")\n  : (body.genres || \"Aventura\");\nconst background   = (body.background || \"Uma figura misteriosa sem passado conhecido.\").trim();\n\nconst validDifficulties = [\"easy\", \"normal\", \"hard\", \"impossible\"];\nconst difficulty = validDifficulties.includes(body.difficulty)\n  ? body.difficulty\n  : \"normal\";\n\nconst storyId = body.story_id;\nif (!storyId) {\n  throw new Error(\"story_id Ã© obrigatÃ³rio e nÃ£o foi fornecido no webhook\");\n}\n\n// =========================================\n// 2. MAPEAMENTO DE SISTEMAS\n// =========================================\nconst rpgSystems = {\n  dnd: {\n    name:       \"Dungeons & Dragons 5Âª EdiÃ§Ã£o\",\n    tone:       \"Ã©pico e fantÃ¡stico\",\n    setting:    \"Reinos esquecidos com ruÃ­nas antigas, masmorras perigosas e magia selvagem\",\n    itemStyle:  \"medieval-fantÃ¡stico\",\n    skills:     [\"ForÃ§a\", \"Destreza\", \"ConstituiÃ§Ã£o\", \"Intelecto\", \"Sabedoria\", \"Carisma\"],\n    threats:    \"dragÃµes, necromantes, cultos demonÃ­acos, mortos-vivos\",\n    atmosphere: \"grandiosa, com conflitos entre bem e mal claramente definidos\",\n    // HP base por nÃ­vel 1 â€” usado para estimar HP dos NPCs iniciais\n    npcHpBase:  12,\n  },\n  cyber: {\n    name:       \"Cyberpunk Red\",\n    tone:       \"noir tecnolÃ³gico e conspiratÃ³rio\",\n    setting:    \"Megacidades controladas por corporaÃ§Ãµes, onde a linha entre humano e mÃ¡quina se dissolve\",\n    itemStyle:  \"high-tech corporativo\",\n    skills:     [\"Reflexos\", \"TÃ©cnica\", \"Corpo\", \"Intelecto\", \"Vontade\", \"Empatia\"],\n    threats:    \"corporaÃ§Ãµes predatÃ³rias, gangues de rua, IAs renegadas, netrunners hostis\",\n    atmosphere: \"claustrofÃ³bica e paranoica, onde todos tÃªm segundas intenÃ§Ãµes\",\n    npcHpBase:  14,\n  },\n  vampire: {\n    name:       \"Vampire: The Masquerade\",\n    tone:       \"sombrio e intimista\",\n    setting:    \"MetrÃ³poles noturnas governadas pela Camarilla, onde a MÃ¡scara oculta a verdade dos mortais\",\n    itemStyle:  \"urbano-oculto\",\n    skills:     [\"FÃ­sico\", \"Social\", \"Mental\", \"PresenÃ§a\", \"ManipulaÃ§Ã£o\", \"Carisma\"],\n    threats:    \"caÃ§adores da Segunda InquisiÃ§Ã£o, Sabbat fanÃ¡ticos, a Besta interior, traiÃ§Ã£o polÃ­tica\",\n    atmosphere: \"gÃ³tica e introspectiva, explorando a perda de humanidade\",\n    npcHpBase:  16,\n  },\n  fallout: {\n    name:       \"Fallout RPG\",\n    tone:       \"pÃ³s-apocalÃ­ptico com humor negro\",\n    setting:    \"AmÃ©rica devastada por guerra nuclear, onde a civilizaÃ§Ã£o renasce entre as ruÃ­nas\",\n    itemStyle:  \"sucata funcional\",\n    skills:     [\"ForÃ§a\", \"PercepÃ§Ã£o\", \"ResistÃªncia\", \"Carisma\", \"Intelecto\", \"Agilidade\", \"Sorte\"],\n    threats:    \"mutantes irradiados, saqueadores, supermutantes, corporaÃ§Ãµes prÃ©-guerra reativadas\",\n    atmosphere: \"retrofuturista e satÃ­rica, equilibrando horror e esperanÃ§a\",\n    npcHpBase:  15,\n  },\n};\nconst sys = rpgSystems[systemId] || rpgSystems.dnd;\n\n// =========================================\n// 3. BALANCEAMENTO DE DIFICULDADE\n// =========================================\nconst difficultyConfig = {\n  easy:       { label: \"Narrativa\",   diffMod: -3, desc: \"Foco na histÃ³ria, combates evitÃ¡veis\",        hpMult: 0.8 },\n  normal:     { label: \"Equilibrado\", diffMod:  0, desc: \"Desafio justo com risco moderado\",             hpMult: 1.0 },\n  hard:       { label: \"DifÃ­cil\",     diffMod: +3, desc: \"Desafios brutais e recursos escassos\",         hpMult: 1.2 },\n  impossible: { label: \"Pesadelo\",    diffMod: +5, desc: \"Morte iminente, sobrevivÃªncia incerta\",        hpMult: 1.5 },\n};\nconst diff = difficultyConfig[difficulty];\n\n// =========================================\n// 4. PERSONA DO SYSTEM (IA)\n// =========================================\nconst systemPersona = `VocÃª Ã© um Game Master veterano com 20+ anos de experiÃªncia em ${sys.name}.\n\nSEU PAPEL:\n- Criar o cenÃ¡rio inicial imersivo e memorÃ¡vel que respeita o tom do sistema\n- Definir o estado inicial COMPLETO do mundo para que o engine de jogo funcione corretamente\n- Gerar personagens secundÃ¡rios com HP codificado no formato exigido pelo engine\n- Todos os campos do JSON de retorno sÃ£o OBRIGATÃ“RIOS â€” engine quebra se algum faltar\n\nOBRIGAÃ‡ÃƒO CRÃTICA:\nRetorne EXCLUSIVAMENTE um objeto JSON vÃ¡lido. Nenhum texto antes ou depois do JSON.`;\n\n// =========================================\n// 5. INSTRUÃ‡Ã•ES DETALHADAS\n// =========================================\nconst userInstructions = `\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\nâ•‘               GERAÃ‡ÃƒO DE AVENTURA INICIAL V6.0                 â•‘\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nPERSONAGEM:\nâ€¢ Nome: ${charName}\nâ€¢ Classe/ArquÃ©tipo: ${className}\nâ€¢ Background: ${background}\n\nSISTEMA & CONFIGURAÃ‡ÃƒO:\nâ€¢ RPG: ${sys.name}\nâ€¢ Setting: ${sys.setting}\nâ€¢ Tom: ${sys.tone}\nâ€¢ Atmosfera: ${sys.atmosphere}\nâ€¢ GÃªnero(s): ${genres}\n\nDIFICULDADE: ${diff.label} (${diff.desc})\nâ€¢ Modificador de Desafio: ${diff.diffMod >= 0 ? \"+\" : \"\"}${diff.diffMod}\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\nâ•‘         REGRAS CRÃTICAS DO ENGINE â€” LEIA COM ATENÃ‡ÃƒO           â•‘\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n[REGRA 1 â€” NPCs com HP]\nCada NPC em \"active_npcs\" DEVE ter HP codificado no nome, no formato exato:\n  \"Nome do NPC [HP:ATUAL/MAX]\"\n  Exemplos vÃ¡lidos:\n    \"Guarda da Cidade [HP:14/14]\"\n    \"Mercador Suspeito [HP:10/10]\"\n    \"Goblin Explorador [HP:8/8]\"\nO HP mÃ¡ximo de um NPC nÃ­vel 1 Ã© aproximadamente ${Math.round(sys.npcHpBase * diff.hpMult)}.\nNPCs aliados tambÃ©m precisam de HP. NPCs puramente sociais sem risco de combate podem omitir HP.\n\n[REGRA 2 â€” Tipo de item do inventÃ¡rio]\nO campo \"type\" em inventory sÃ³ aceita: \"consumable\", \"weapon\", \"armor\", \"misc\"\nNÃƒO use: \"equipment\", \"quest_item\", \"potion\" â€” esses nÃ£o sÃ£o reconhecidos.\n\n[REGRA 3 â€” armor_class calculado]\nCalcule a CA inicial: 10 + bÃ´nus de armadura. Inclua no campo \"armor_class\".\nExemplo: sem armadura = 10, couro = 11, malha = 13.\n\n[REGRA 4 â€” Estado de combate]\nSempre retorne \"in_combat\": false e \"combat_target\": null no inÃ­cio.\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\nâ•‘                  SCHEMA JSON COMPLETO EXIGIDO                  â•‘\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n{\n  \"narrative\": \"Texto narrativo imersivo (mÃ­n. 3 parÃ¡grafos) separados por \\\\n\\\\n.\",\n\n  \"choices\": [\n    {\n      \"text\": \"AÃ§Ã£o fÃ­sica/combate\",\n      \"type\": \"action\",\n      \"skillCheck\": \"${sys.skills[0]}\",\n      \"difficulty\": ${12 + diff.diffMod},\n      \"diceType\": \"d20\"\n    },\n    {\n      \"text\": \"AÃ§Ã£o investigativa\",\n      \"type\": \"investigate\",\n      \"skillCheck\": \"${sys.skills[3]}\",\n      \"difficulty\": ${14 + diff.diffMod},\n      \"diceType\": \"d20\"\n    },\n    {\n      \"text\": \"AÃ§Ã£o social\",\n      \"type\": \"social\",\n      \"skillCheck\": \"${sys.skills[5]}\",\n      \"difficulty\": ${11 + diff.diffMod},\n      \"diceType\": \"d20\"\n    },\n    {\n      \"text\": \"Abordagem criativa/furtiva\",\n      \"type\": \"stealth\"\n    }\n  ],\n\n  \"inventory\": [\n    {\n      \"name\": \"Nome do item de consumo\",\n      \"description\": \"O que ele faz.\",\n      \"quantity\": 1,\n      \"type\": \"consumable\",\n      \"effect_data\": { \"heal\": 8 },\n      \"value\": 10\n    },\n    {\n      \"name\": \"Arma ou armadura avulsa (se aplicÃ¡vel)\",\n      \"description\": \"DescriÃ§Ã£o.\",\n      \"quantity\": 1,\n      \"type\": \"weapon\",\n      \"effect_data\": {},\n      \"value\": 25\n    }\n  ],\n\n  \"equipment\": [\n    {\n      \"name\": \"Arma inicial compatÃ­vel com ${className}\",\n      \"slot\": \"main_hand\",\n      \"stats\": { \"damage\": \"1d6\" },\n      \"icon\": \"âš”ï¸\"\n    },\n    {\n      \"name\": \"Armadura/roupa inicial compatÃ­vel com ${className}\",\n      \"slot\": \"body\",\n      \"stats\": { \"armor\": 1 },\n      \"icon\": \"ðŸ›¡ï¸\"\n    }\n  ],\n\n  \"active_npcs\": [\n    \"Nome do NPC Principal [HP:${Math.round(sys.npcHpBase * diff.hpMult)}/${Math.round(sys.npcHpBase * diff.hpMult)}]\",\n    \"Nome do NPC SecundÃ¡rio [HP:${Math.round(sys.npcHpBase * diff.hpMult * 0.7)}/${Math.round(sys.npcHpBase * diff.hpMult * 0.7)}]\"\n  ],\n\n  \"current_location\": \"Nome exato do local onde a cena comeÃ§a (ex: Taverna do Corvo Partido, RuÃ­nas de Vel'Than)\",\n\n  \"active_quests\": [\n    \"Objetivo principal imediato (ex: Escapar da prisÃ£o antes do amanhecer)\"\n  ],\n\n  \"armor_class\": NÃšMERO_INTEIRO_CALCULADO,\n\n  \"in_combat\": false,\n\n  \"combat_target\": null,\n\n  \"status_effects\": [],\n\n  \"world_flags\": [],\n\n  \"metadata\": {\n    \"initial_threat\": \"AmeaÃ§a principal estabelecida\",\n    \"time_of_day\": \"manhÃ£|tarde|noite|madrugada\",\n    \"atmosphere\": \"${sys.tone}\"\n  }\n}\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\nâ•‘                       VALIDAÃ‡ÃƒO FINAL                          â•‘\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâ˜‘ JSON vÃ¡lido sem texto externo.\nâ˜‘ \"active_npcs\" â€” todas as strings com tag [HP:X/X].\nâ˜‘ \"current_location\" â€” preenchido obrigatoriamente.\nâ˜‘ \"active_quests\" â€” mÃ­nimo 1 objetivo.\nâ˜‘ \"inventory.type\" â€” apenas: consumable | weapon | armor | misc.\nâ˜‘ \"armor_class\" â€” nÃºmero inteiro (ex: 11).\nâ˜‘ \"in_combat\": false, \"combat_target\": null.\nâ˜‘ \"status_effects\": [] e \"world_flags\": [] presentes.\n`.trim();\n\n// =========================================\n// 6. RETORNO â€” separado em ai_request e metadata\n//    ai_request â†’ corpo do HTTP Request (Mistral)\n//    init_context â†’ usado pelo Parser de InÃ­cio\n// =========================================\nreturn {\n  json: {\n    // â”€â”€ O que vai para o Mistral via HTTP Request â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    ai_request: {\n      model: \"mistral-large-latest\",\n      messages: [\n        { role: \"system\", content: systemPersona },\n        { role: \"user\",   content: userInstructions },\n      ],\n      temperature: 0.75,\n      max_tokens:  4000,\n      response_format: { type: \"json_object\" },\n    },\n\n    // â”€â”€ Contexto para o Parser de InÃ­cio (nÃ³ seguinte) â”€â”€â”€â”€â”€â”€\n    // Acesso: $('GeraÃ§Ã£o Inicial V6').first().json.init_context\n    init_context: {\n      story_id:       String(storyId),\n      system_id:      systemId,\n      difficulty:     difficulty,\n      genres:         genres,\n      character_name: charName,\n      class_name:     className,\n      background:     background,\n      npc_hp_base:    Math.round(sys.npcHpBase * diff.hpMult),\n      diff_mod:       diff.diffMod,\n    },\n  },\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2704,-800],"id":"86bf39a5-6a5f-4d6d-ae56-3ba58df587d3","name":"Code in JavaScript"},{"parameters":{"jsCode":"let initCtx;\ntry {\n  initCtx = $(\"GeraÃ§Ã£o Inicial V6\").first().json.init_context;\n} catch (e) {\n  // Fallback caso o nome do nÃ³ seja diferente\n  initCtx = $input.first().json.init_context || {};\n}\n\nconst storyId = $('Code in JavaScript').first().json.init_context.story_id;\nif (!storyId) throw new Error(\"ERRO CRÃTICO: story_id nÃ£o encontrado no init_context.\");\n\n// Response da IA (vem do HTTP Request â†’ Mistral)\nconst aiRaw     = $input.first().json;\nconst aiContent = aiRaw.choices[0].message.content;\n\n// =========================================\n// 2. PARSE E LIMPEZA DO JSON DA IA\n// =========================================\nlet cleanJson = aiContent\n  .replace(/```json/gi, \"\")\n  .replace(/```/g,     \"\")\n  .trim();\n\n// Sanitiza quebras de linha dentro de strings JSON\ncleanJson = cleanJson.replace(/\"((?:[^\"\\\\]|\\\\.)*)\"/g, (match) => {\n  return match\n    .replace(/\\n/g, \"\\\\n\")\n    .replace(/\\r/g, \"\")\n    .replace(/\\t/g, \"\\\\t\");\n});\n\nlet parsed;\ntry {\n  parsed = JSON.parse(cleanJson);\n} catch (error) {\n  throw new Error(\"FALHA JSON: \" + error.message + \"\\nConteÃºdo recebido: \" + aiContent.substring(0, 200));\n}\n\n// =========================================\n// 3. NORMALIZAÃ‡ÃƒO DE SLOTS DE EQUIPAMENTO\n// =========================================\nconst VALID_SLOTS = [\"head\", \"body\", \"legs\", \"main_hand\", \"off_hand\", \"accessory\"];\n\nconst SLOT_MAP = {\n  ring:    \"accessory\", amulet: \"accessory\", neck: \"accessory\",\n  back:    \"accessory\", cloak:  \"accessory\", trinket: \"accessory\",\n  chest:   \"body\",      torso:  \"body\",      armor: \"body\",\n  feet:    \"legs\",      boots:  \"legs\",      shoes: \"legs\",\n  weapon:  \"main_hand\", sword:  \"main_hand\", axe: \"main_hand\",\n  hand:    \"main_hand\", dagger: \"main_hand\",\n  shield:  \"off_hand\",\n};\n\nconst equipamentoFinal = (parsed.equipment || []).map((item) => {\n  let safeSlot = (item.slot || \"accessory\").toLowerCase();\n  if (!VALID_SLOTS.includes(safeSlot)) {\n    safeSlot = SLOT_MAP[safeSlot] || \"accessory\";\n  }\n  return {\n    story_id: storyId,\n    name:     item.name  || \"Equipamento\",\n    slot:     safeSlot,\n    stats:    item.stats || {},\n    icon:     item.icon  || \"ðŸ“¦\",\n  };\n});\n\n// =========================================\n// 4. NORMALIZAÃ‡ÃƒO DE TIPOS DE INVENTÃRIO\n// [CORREÃ‡ÃƒO 5] â€” alinha com o filtro do Mestre Unificado V6\n// =========================================\nconst VALID_INV_TYPES = [\"consumable\", \"weapon\", \"armor\", \"misc\"];\n\n// Mapa de tipos incorretos â†’ tipos aceitos pelo banco\nconst INV_TYPE_MAP = {\n  equipment:  \"weapon\",   // \"equipment\" genÃ©rico â†’ weapon (mais comum)\n  potion:     \"consumable\",\n  food:       \"consumable\",\n  quest_item: \"misc\",\n  tool:       \"misc\",\n};\n\nconst inventarioFinal = (parsed.inventory || []).map((item) => {\n  let safeType = (item.type || \"misc\").toLowerCase();\n  if (!VALID_INV_TYPES.includes(safeType)) {\n    safeType = INV_TYPE_MAP[safeType] || \"misc\";\n  }\n  return {\n    story_id:    storyId,\n    name:        item.name        || \"Item\",\n    description: item.description || \"\",\n    quantity:    Math.max(1, parseInt(item.quantity) || 1),\n    type:        safeType,\n    effect_data: item.effect_data || {},\n    value:       parseInt(item.value) || 0,\n  };\n});\n\n// =========================================\n// 5. PROCESSAMENTO DE NPCs\n// [CORREÃ‡ÃƒO 4] â€” preserva tag [HP:X/X], gera se ausente\n// =========================================\nconst NPC_HP_BASE = initCtx.npc_hp_base || 12;\n\nfunction ensureNpcHp(npcStr) {\n  if (!npcStr || typeof npcStr !== \"string\") return null;\n  const clean = npcStr.trim();\n  if (clean === \"\") return null;\n\n  // JÃ¡ tem HP codificado â€” preserva como estÃ¡\n  if (/\\[HP:\\d+\\/\\d+\\]/.test(clean)) return clean;\n\n  // NÃ£o tem HP â€” gera valor padrÃ£o baseado no sistema/dificuldade\n  const hp = NPC_HP_BASE + Math.floor(Math.random() * 5) - 2; // Â±2 variaÃ§Ã£o\n  const safeHp = Math.max(5, hp);\n  return `${clean} [HP:${safeHp}/${safeHp}]`;\n}\n\nconst activeNpcsFinal = (parsed.active_npcs || [])\n  .map(ensureNpcHp)\n  .filter(Boolean);\n\n// =========================================\n// 6. CAMPOS NOVOS DO ENGINE V6\n// [CORREÃ‡ÃƒO 1] status_effects\n// [CORREÃ‡ÃƒO 2] world_flags\n// [CORREÃ‡ÃƒO 3] in_combat, combat_target\n// [CORREÃ‡ÃƒO 3] armor_class\n// [CORREÃ‡ÃƒO 5] current_summary\n// =========================================\n\n// status_effects: deve ser array de objetos. Se ausente ou invÃ¡lido, usa []\nconst statusEffects = Array.isArray(parsed.status_effects)\n  ? parsed.status_effects\n  : [];\n\n// world_flags: array de {flag_key, flag_value}. Se ausente, usa []\n// O Mestre Unificado V6 espera: [{flag_key: \"...\", flag_value: ...}]\nconst worldFlagsRaw = parsed.world_flags || {};\nlet worldFlagsFinal = [];\nif (Array.isArray(worldFlagsRaw)) {\n  worldFlagsFinal = worldFlagsRaw;\n} else if (typeof worldFlagsRaw === \"object\") {\n  // Suporte ao formato alternativo {\"key\": value}\n  worldFlagsFinal = Object.entries(worldFlagsRaw).map(([k, v]) => ({\n    story_id:   storyId,\n    flag_key:   k,\n    flag_value: v,\n  }));\n}\n\n// in_combat: sempre false no inÃ­cio\nconst inCombat = false;\n\n// combat_target: sempre null no inÃ­cio\nconst combatTarget = null;\n\n// armor_class: usa o valor da IA ou calcula pela armadura\nconst armorEquipped = equipamentoFinal.find((e) => e.slot === \"body\");\nconst armorBonus    = armorEquipped?.stats?.armor || 0;\nconst armorClass    = typeof parsed.armor_class === \"number\"\n  ? parsed.armor_class\n  : 10 + armorBonus;\n\n// =========================================\n// 7. CAMPOS BÃSICOS\n// =========================================\n\n// Narrativa inicial (vai para tabela messages como \"narrator\")\nconst narrativaFinal = {\n  story_id: storyId,\n  sender:   \"narrator\",\n  content:  parsed.narrative || \"Sua aventura comeÃ§a...\",\n};\n\n// Choices iniciais (vai para tabela messages junto com narrativa)\nconst choicesFinal = (parsed.choices || []).map((choice) => ({\n  story_id:    storyId,\n  text:        choice.text        || \"...\",\n  type:        choice.type        || \"action\",\n  skill_check: choice.skillCheck  || null,\n  difficulty:  choice.difficulty  || 10,\n  dice_type:   choice.diceType    || \"d20\",\n}));\n\n// Location\nconst currentLocationFinal =\n  parsed.current_location && parsed.current_location.trim() !== \"\"\n    ? parsed.current_location.trim()\n    : \"Local Desconhecido\";\n\n// Quests\nconst activeQuestsFinal = Array.isArray(parsed.active_quests)\n  ? parsed.active_quests.filter((q) => typeof q === \"string\" && q.trim() !== \"\")\n  : [];\n\n// =========================================\n// 8. RETORNO COMPLETO â€” campos FLAT para acesso direto via $json no n8n\n//\n// PATCH stories  â†’ $json.active_npcs | $json.current_location\n//                   $json.active_quests | $json.armor_class\n//                   $json.in_combat | $json.combat_target\n//                   $json.status_effects\n//\n// POST messages  â†’ $json.narrativa\n// POST choices   â†’ $json.choices   (array â€” usar Split ou loop)\n// POST items     â†’ $json.inventario (array â€” usar Split ou loop)\n// POST equipment â†’ $json.equipamento (array â€” usar Split ou loop)\n// POST world_flags â†’ $json.world_flags (array â€” usar Split ou loop)\n//                    cada item jÃ¡ tem story_id, flag_key, flag_value\n// =========================================\nreturn {\n  json: {\n    // â”€â”€ IdentificaÃ§Ã£o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    story_id: storyId,\n\n    // â”€â”€ PATCH stories â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    // Body: { \"active_npcs\": $json.active_npcs,\n    //         \"current_location\": $json.current_location,\n    //         \"active_quests\": $json.active_quests,\n    //         \"armor_class\": $json.armor_class,\n    //         \"in_combat\": $json.in_combat,\n    //         \"combat_target\": $json.combat_target,\n    //         \"status_effects\": $json.status_effects }\n    active_npcs:      activeNpcsFinal,\n    current_location: currentLocationFinal,\n    active_quests:    activeQuestsFinal,\n    armor_class:      armorClass,\n    in_combat:        inCombat,\n    combat_target:    combatTarget,\n    status_effects:   statusEffects,\n\n    // â”€â”€ POST messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    // Body: $json.narrativa\n    narrativa: narrativaFinal,\n\n    // â”€â”€ POST choices â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    // Body: $json.choices  (usar nÃ³ Split para iterar)\n    choices: choicesFinal,\n\n    // â”€â”€ POST items â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    // Body: $json.inventario  (usar nÃ³ Split para iterar)\n    inventario: inventarioFinal,\n\n    // â”€â”€ POST equipment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    // Body: $json.equipamento  (usar nÃ³ Split para iterar)\n    equipamento: equipamentoFinal,\n\n    // â”€â”€ POST world_flags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    // Body: $json.world_flags  (usar nÃ³ Split para iterar)\n    // Formato por item: { story_id, flag_key, flag_value }\n    // Geralmente [] no inÃ­cio â€” nÃ³ sÃ³ executa se array nÃ£o estiver vazio\n    world_flags: worldFlagsFinal.map((f) => ({\n      story_id:   storyId,\n      flag_key:   f.flag_key   || f.key   || \"\",\n      flag_value: f.flag_value ?? f.value ?? null,\n    })).filter((f) => f.flag_key !== \"\"),\n\n    // â”€â”€ Debug â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    summary: {\n      location:        currentLocationFinal,\n      npcs_count:      activeNpcsFinal.length,\n      quests_count:    activeQuestsFinal.length,\n      inventory_count: inventarioFinal.length,\n      equipment_count: equipamentoFinal.length,\n      armor_class:     armorClass,\n      in_combat:       inCombat,\n      status_effects:  statusEffects.length,\n      world_flags:     worldFlagsFinal.length,\n    },\n  },\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2448,-800],"id":"dae1a091-f12f-4e57-9e9b-b9d3aa7924c5","name":"Code in JavaScript1"},{"parameters":{"method":"POST","url":"https://jmjezldxisifcdjacwnb.supabase.co/rest/v1/messages","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"return=minimal"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.narrativa }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-2272,-864],"id":"862b643b-d1ca-4431-90ed-7f47f5df98ca","name":"HTTP Request","credentials":{"supabaseApi":{"id":"3ssV9qtsZUAklVtZ","name":"Supabase account 2"}}},{"parameters":{"method":"POST","url":"https://jmjezldxisifcdjacwnb.supabase.co/rest/v1/items","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"return=minimal"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.inventario }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-2272,-736],"id":"e8d872a3-6f9f-4d79-bc17-57bcdefec848","name":"HTTP Request2","credentials":{"supabaseApi":{"id":"3ssV9qtsZUAklVtZ","name":"Supabase account 2"}}},{"parameters":{"method":"POST","url":"https://jmjezldxisifcdjacwnb.supabase.co/rest/v1/equipment","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"return=minimal"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.equipamento }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-2272,-624],"id":"d2dec4c4-d523-462a-80ee-b94fe7c25ab8","name":"HTTP Request3","credentials":{"supabaseApi":{"id":"3ssV9qtsZUAklVtZ","name":"Supabase account 2"}}},{"parameters":{"method":"POST","url":"https://jmjezldxisifcdjacwnb.supabase.co/rest/v1/choices","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"return=minimal"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.choices }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-2272,-512],"id":"263c5c94-7635-4aae-863a-425f89b15bf1","name":"HTTP Request4","credentials":{"supabaseApi":{"id":"3ssV9qtsZUAklVtZ","name":"Supabase account 2"}}},{"parameters":{"path":"resumo","authentication":"headerAuth","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-2032,-944],"id":"1ddaf252-a0c7-4bfd-85e7-f78e44a3b7df","name":"Webhook1","webhookId":"ba1b6f1b-c24f-4eae-9e70-25e15b4e3d6d","credentials":{"httpHeaderAuth":{"id":"vUs8rqLIlN9NCNTc","name":"Header Auth account"}}},{"parameters":{"url":"https://jmjezldxisifcdjacwnb.supabase.co/rest/v1/stories","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendQuery":true,"specifyQuery":"json","jsonQuery":"={\n  \"select\": \"current_summary, system, difficulty, character_name, class_name, genres, messages(sender,content,created_at)\",\n  \"id\": \"eq.{{ $json.body.story_id }}\",\n  \"messages.order\": \"created_at.desc\",\n  \"messages.limit\": \"10\"\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-1856,-944],"id":"b2a5c097-d815-4c84-8a20-7daba7eb6338","name":"HTTP Request5","credentials":{"supabaseApi":{"id":"3ssV9qtsZUAklVtZ","name":"Supabase account 2"}}},{"parameters":{"jsCode":"// =========================================================\n// PREPARADOR DE PAYLOAD (RESUMO DA HISTÃ“RIA)\n// =========================================================\n\n// 1. Receber dados do Supabase\nconst storyData = items[0].json;\n\nif (!storyData) {\n  throw new Error(\"HistÃ³ria nÃ£o encontrada.\");\n}\n\n// 2. Extrair e Ordenar Mensagens\nlet recentMessages = storyData.messages || [];\n// O banco traz as mais recentes primeiro, invertemos para ordem cronolÃ³gica\nrecentMessages.reverse();\n\n// 3. Preparar o Contexto Anterior\nconst currentSummary = storyData.current_summary || \"\";\nconst DEFAULT_TEXT = \"A aventura comeÃ§ou recentemente...\";\nlet contextText = \"\";\n\nif (currentSummary.includes(DEFAULT_TEXT) || currentSummary.trim() === \"\") {\n    contextText = \"CONTEXTO ANTERIOR: A histÃ³ria estÃ¡ no inÃ­cio. NÃ£o hÃ¡ resumo prÃ©vio.\";\n} else {\n    contextText = `CONTEXTO ANTERIOR:\\n\"${currentSummary}\"`;\n}\n\n// 4. Formatar o Log de DiÃ¡logos\nconst chatLogText = recentMessages.map(msg => {\n    const role = msg.sender === 'player' ? 'JOGADOR' : 'MESTRE';\n    // Remove quebras de linha extras para economizar tokens\n    return `[${role}]: ${msg.content ? msg.content.replace(/\\n+/g, \" \") : \"\"}`;\n}).join(\"\\n\");\n\n// 5. DefiniÃ§Ã£o do SYSTEM PERSONA (O Cronista)\nconst systemPersona = `\nVocÃª Ã© o CRONISTA DE UM RPG. Sua funÃ§Ã£o Ã© manter a memÃ³ria de longo prazo da aventura.\nVocÃª receberÃ¡ um 'Contexto Anterior' e as 'Ãšltimas 10 Mensagens'.\nSeu objetivo Ã© fundir ambos em um Ãºnico texto narrativo denso e coeso.\n\nREGRAS:\n- Escreva em 3Âª pessoa.\n- MÃ¡ximo de 3 parÃ¡grafos.\n- Mantenha fatos cruciais (nomes, itens chave, ferimentos, locais).\n- Descarte diÃ¡logos triviais.\n- Se o contexto for \"A histÃ³ria estÃ¡ no inÃ­cio\", ignore-o e resuma apenas as mensagens novas.\n`.trim();\n\n// 6. DefiniÃ§Ã£o das INSTRUÃ‡Ã•ES DO USUÃRIO\nconst userInstructions = `\n${contextText}\n\n--- NOVOS EVENTOS (LOG) ---\n${chatLogText}\n--- FIM DO LOG ---\n\nGere o novo resumo atualizado agora.\n`.trim();\n\n// 7. Tratamento dos GÃªneros (CORREÃ‡ÃƒO DO ERRO)\n// A API exige string, entÃ£o transformamos [\"AÃ§Ã£o\", \"Terror\"] em \"AÃ§Ã£o, Terror\"\nconst genresString = Array.isArray(storyData.genres) \n    ? storyData.genres.join(\", \") \n    : String(storyData.genres || \"\");\n\n// 8. Retornar o Objeto Formatado para a API\nreturn {\n  json: {\n    model: \"mistral-small-latest\",\n    messages: [\n      { role: \"system\", content: systemPersona },\n      { role: \"user\", content: userInstructions }\n    ],\n    temperature: 0.5,\n    max_tokens: 2000,\n    \n    metadata: {\n      story_id: String($json.story_id),\n      system_id: String(storyData.system || \"unknown\"),\n      difficulty: String(storyData.difficulty || \"normal\"),\n      character_name: String(storyData.character_name || \"Heroi\"),\n      character_class: String(storyData.class_name || \"Aventureiro\"),\n      genres: genresString, // AQUI ESTAVA O ERRO (Agora Ã© string)\n      task: \"summary_generation\"\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1696,-944],"id":"e8878cf1-b857-4b86-9a8d-f119f50e09b1","name":"Code in JavaScript2"},{"parameters":{"method":"POST","url":"https://api.mistral.ai/v1/chat/completions","authentication":"predefinedCredentialType","nodeCredentialType":"mistralCloudApi","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-1536,-944],"id":"81161a82-6ef2-48f5-a32d-eb8010064db0","name":"HTTP Request6","credentials":{"mistralCloudApi":{"id":"HbOWghtcXEf7jxxj","name":"Mistral Cloud account"},"openRouterApi":{"id":"mCdp8OcIGuBAlyxd","name":"OpenRouter account"}}},{"parameters":{"jsCode":"// =========================================================\n// PARSER: LIMPEZA DO RESUMO GERADO (V3 - Hardcoded Paths)\n// =========================================================\n\n// 1. Acessar a resposta da IA (Do input do nÃ³ anterior)\n// Caminho fornecido: $input.first().json.choices[0].message.content\nconst aiResponse = $input.first().json;\n\nif (!aiResponse || !aiResponse.choices) {\n  throw new Error(\"A resposta da IA veio vazia ou em formato incorreto.\");\n}\n\nconst content = aiResponse.choices[0].message.content;\n\n// 2. Limpeza de Texto\nlet cleanSummary = content.trim();\n\n// Remove aspas extras se houver\nif (cleanSummary.startsWith('\"') && cleanSummary.endsWith('\"')) {\n    cleanSummary = cleanSummary.slice(1, -1);\n}\n\n// Remove prefixos comuns da IA (ex: \"Aqui estÃ¡ o resumo...\")\ncleanSummary = cleanSummary.replace(/^Aqui estÃ¡ o resumo.*?:[\\s\\n]*/i, \"\");\ncleanSummary = cleanSummary.replace(/^Resumo:[\\s\\n]*/i, \"\");\n\n// 3. Recuperar o ID da HistÃ³ria\n// Caminho fornecido: $('Webhook1').first().json.body.story_id\nlet storyId;\n\ntry {\n    // Tenta pegar exatamente onde vocÃª indicou\n    storyId = $('Webhook1').first().json.body.story_id;\n} catch (error) {\n    // Se o nÃ³ \"Webhook1\" nÃ£o existir ou o caminho falhar, lanÃ§a erro claro\n    throw new Error(\"NÃ£o foi possÃ­vel encontrar o 'story_id' no nÃ³ 'Webhook1'. Verifique se o nÃ³ Gatilho tem EXATAMENTE o nome 'Webhook1'.\");\n}\n\n// 4. Retorno Limpo para o prÃ³ximo nÃ³ (Update Supabase)\nreturn {\n  json: {\n    story_id: storyId,\n    new_summary: cleanSummary,\n    updated_at: new Date().toISOString()\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1392,-944],"id":"81087f6d-aa68-422c-a95c-4c87ec587157","name":"Code in JavaScript3"},{"parameters":{"method":"PATCH","url":"https://jmjezldxisifcdjacwnb.supabase.co/rest/v1/stories","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendQuery":true,"specifyQuery":"json","jsonQuery":"={\n  \"id\": \"eq.{{ $json.story_id }}\"\n}","sendBody":true,"specifyBody":"json","jsonBody":"={{\n  {\n    \"current_summary\": $json.new_summary\n  }\n}}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-1248,-944],"id":"c7dbf347-be3e-4cf4-8e18-5fa22f5f1a23","name":"HTTP Request7","credentials":{"supabaseApi":{"id":"3ssV9qtsZUAklVtZ","name":"Supabase account 2"}}},{"parameters":{"httpMethod":"POST","path":"storie","authentication":"headerAuth","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-2032,-656],"id":"96264889-484d-4e9e-ae11-3f4f7efbe2e3","name":"Webhook2","webhookId":"ba1b6f1b-c24f-4eae-9e70-25e15b4e3d6d","credentials":{"httpHeaderAuth":{"id":"vUs8rqLIlN9NCNTc","name":"Header Auth account"}}},{"parameters":{"url":"https://jmjezldxisifcdjacwnb.supabase.co/rest/v1/stories","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendQuery":true,"specifyQuery":"json","jsonQuery":"={\n  \"select\": \"id, current_summary, current_location, active_npcs, active_quests, system, difficulty, character_name, class_name, background, genres, gold, level, experience, hp_current, hp_max, armor_class, attributes, in_combat, combat_target, status_effects, messages(sender, content, created_at, roll_result), items(name, quantity, description, type, effect_data, value), equipment(name, slot, stats, icon)\",\n  \"id\": \"eq.{{ $json.body.story_id }}\",\n  \"messages.order\": \"created_at.desc\",\n  \"messages.limit\": \"10\"\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-1888,-656],"id":"a431c86e-0fbd-4340-9c03-fbf4be1ccdc2","name":"HTTP Request8","credentials":{"supabaseApi":{"id":"3ssV9qtsZUAklVtZ","name":"Supabase account 2"}}},{"parameters":{"jsCode":"const inputData = items[0].json;\nconst raw = Array.isArray(inputData) ? inputData[0] : (inputData.story_data || inputData);\n\nif (!raw || !raw.id) throw new Error(\"Dados da histÃ³ria nÃ£o encontrados.\");\n\n// 1. Mensagens (Inverte para ordem cronolÃ³gica)\nconst messages = Array.isArray(raw.messages) ? raw.messages.slice().reverse() : [];\n\n// 2. Ãšltima AÃ§Ã£o\nconst lastPlayerMsg = messages.slice().reverse().find(m => m.sender === \"player\");\nconst playerAction  = lastPlayerMsg?.content || \"Olhar ao redor\";\n\nconst activeNPCs = Array.isArray(raw.active_npcs) ? raw.active_npcs : [];\nconst npcsListRouter = activeNPCs\n    .map(n => n.replace(/\\s*\\[HP:\\d+\\/\\d+\\]/g, \"\").trim()) // Remove a tag de HP\n    .join(\", \") || \"NinguÃ©m\";\n\n// 4. Prompt do Roteador\nconst systemPrompt = `\nVocÃª Ã© o CLASSIFICADOR DE INTENÃ‡ÃƒO de uma Engine de RPG.\nAnalise a AÃ‡ÃƒO DO JOGADOR e o CONTEXTO para decidir o MÃ³dulo de IA.\n\nCATEGORIAS:\n- combat:       Atacar alguÃ©m da lista de NPCs, sacar arma hostilmente, defender-se.\n- loot:         Saquear, abrir baÃº, pegar itens.\n- rest:         Dormir, descansar, acampar.\n- levelup:      Evoluir nÃ­vel.\n- travel:       Viajar, mudar de regiÃ£o.\n- craft:        Criar itens.\n- moral:        Dilemas Ã©ticos.\n- commerce:     Comprar, vender, negociar.\n- consequences: Perguntar sobre passado/mundo.\n- narrative:    (PADRÃƒO) Conversar, investigar, persuadir.\n\nREGRAS:\n1. Se o jogador atacar um NPC listado no contexto â†’ COMBAT.\n2. Se o jogador jÃ¡ estiver \"EM COMBATE: Sim\" â†’ COMBAT (exceto se fugir/render).\n3. Se ambÃ­guo â†’ NARRATIVE.\n\nOUTPUT JSON OBRIGATÃ“RIO:\n{ \"mode\": \"nome_da_categoria\" }\n`.trim();\n\nconst userPrompt = `\nRESUMO: ${raw.current_summary ? raw.current_summary.slice(0, 300) : \"InÃ­cio\"}...\nNPCs NA CENA: ${npcsListRouter}\nEM COMBATE: ${raw.in_combat ? \"Sim\" : \"NÃ£o\"}\nAÃ‡ÃƒO DO JOGADOR: \"${playerAction}\"\n\nClassifique a intenÃ§Ã£o.\n`.trim();\n\n// 5. Montagem do Payload\nconst originalData = {\n    story_id:         raw.id,\n    character_name:   raw.character_name   || \"Viajante\",\n    class_name:       raw.class_name       || \"Aventureiro\",\n    system:           raw.system           || \"dnd\",\n    difficulty:       raw.difficulty       || \"normal\",\n    hp_current:       raw.hp_current       ?? 10,\n    hp_max:           raw.hp_max           ?? 10,\n    level:            raw.level            ?? 1,\n    experience:       raw.experience       ?? 0,\n    gold:             raw.gold             ?? 0,\n    armor_class:      raw.armor_class      ?? 10,\n    \n    current_summary:  raw.current_summary  || \"InÃ­cio.\",\n    current_location: raw.current_location || \"Desconhecido\",\n    active_npcs:      activeNPCs, // Manda com HP para o Mestre V6 usar\n    active_quests:    raw.active_quests    || [],\n    \n    // Novos campos V6\n    in_combat:        raw.in_combat        ?? false,\n    combat_target:    raw.combat_target    || null,\n    status_effects:   raw.status_effects   || [],\n    \n    messages:         messages,\n    inventory:        raw.items            || [],\n    equipment:        raw.equipment        || [],\n    world_flags:      raw.world_flags      || []\n};\n\nreturn {\n    json: {\n        ai_payload: {\n            model: \"mistral-small-latest\",\n            messages: [\n                { role: \"system\", content: systemPrompt },\n                { role: \"user\",   content: userPrompt }\n            ],\n            temperature: 0.1,\n            response_format: { type: \"json_object\" }\n        },\n        original_data: originalData\n    }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1744,-656],"id":"1812fe71-f1db-40c3-87e7-269648c94851","name":"Code in JavaScript4"},{"parameters":{"method":"PATCH","url":"https://jmjezldxisifcdjacwnb.supabase.co/rest/v1/stories","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendQuery":true,"specifyQuery":"json","jsonQuery":"={\n  \"id\": \"eq.{{ $json.narrativa.story_id }}\"\n}","sendBody":true,"specifyBody":"json","jsonBody":"={{\n{\n  \"active_npcs\": $json.active_npcs,\n  \"current_location\": $json.current_location,\n  \"active_quests\": $json.active_quests,\n  \"armor_class\": $json.armor_class,\n  \"in_combat\": $json.in_combat,\n  \"combat_target\": $json.combat_target,\n  \"status_effects\": $json.status_effects\n}\n}}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-2272,-992],"id":"33902696-136f-4500-a961-9d2dba486f8c","name":"HTTP Request22","credentials":{"supabaseApi":{"id":"3ssV9qtsZUAklVtZ","name":"Supabase account 2"}}},{"parameters":{"method":"POST","url":"https://api.mistral.ai/v1/chat/completions","authentication":"predefinedCredentialType","nodeCredentialType":"mistralCloudApi","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.ai_payload}}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-1600,-656],"id":"7f3dc6e9-6b01-46b3-851f-bb394bfecd67","name":"HTTP Request9","credentials":{"mistralCloudApi":{"id":"HbOWghtcXEf7jxxj","name":"Mistral Cloud account"},"openRouterApi":{"id":"mCdp8OcIGuBAlyxd","name":"OpenRouter account"}}},{"parameters":{"jsCode":"// =========================================\n// O MESTRE UNIFICADO V6.0\n// Novo: in_combat + combat_target persistidos\n//       status_effects processados antes do turno\n//       world_flags injetadas no contexto narrativo\n// FIX: buildInventoryContext reconhece weapon|armor (antes sÃ³ \"equipment\")\n// FIX: current_npcs adicionado ao parserContext\n// FIX: NPCs exibidos COM HP no commonContext\n// =========================================\n\n// =========================================\n// 1. LEITURA DO ROUTER (IA Pequena)\n// =========================================\nlet detectedMode = \"narrative\";\n\ntry {\n  const aiContent = $input.first().json.choices[0].message.content;\n  const cleanJson = aiContent\n    .replace(/```json/g, \"\")\n    .replace(/```/g, \"\")\n    .trim();\n  const parsed = JSON.parse(cleanJson);\n  if (parsed.mode) detectedMode = parsed.mode.toLowerCase();\n} catch (e) {\n  console.log(\"Router fallback â†’ narrative. Erro: \" + e.message);\n}\n\n// =========================================\n// 2. RECUPERAÃ‡ÃƒO DE DADOS DA HISTÃ“RIA\n// =========================================\nlet storyData = {};\ntry {\n  storyData = $(\"Code in JavaScript4\").first().json.original_data;\n} catch (e) {\n  storyData = $input.first().json.original_data || {};\n}\n\n// =========================================\n// 3. EXTRAÃ‡ÃƒO DE ESTADO (Tabela: stories)\n// =========================================\nconst charName = storyData.character_name || \"Viajante\";\nconst className = storyData.class_name || \"Aventureiro\";\nconst systemId = storyData.system || \"dnd\";\nconst difficulty = storyData.difficulty || \"normal\";\nconst genres = storyData.genres || \"Aventura\";\n\nconst hpCurrent = storyData.hp_current || 10;\nconst hpMax = storyData.hp_max || 10;\nconst level = storyData.level || 1;\nconst experience = storyData.experience || 0;\nconst gold = storyData.gold || 0;\nconst nextLevelXp = level * 1000;\n\nconst inventory = storyData.inventory || [];\nconst equipment = storyData.equipment || [];\nconst activeNPCs = storyData.active_npcs || [];\nconst activeQuests = storyData.active_quests || [];\nconst currentLocation = storyData.current_location || \"Desconhecido\";\nconst lastSnippet = storyData.current_summary || \"InÃ­cio da aventura.\";\n\n// â”€â”€ Novas colunas: stories â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst inCombatDB = storyData.in_combat ?? false;\nconst combatTargetDB = storyData.combat_target || null;\n\nconst statusEffects = Array.isArray(storyData.status_effects)\n  ? storyData.status_effects\n  : [];\n\nconst worldFlags = Array.isArray(storyData.world_flags)\n  ? storyData.world_flags\n  : [];\n\n// Equipamento ativo\nconst weapon = equipment.find((e) => e.slot === \"main_hand\") || {\n  name: \"Punhos\",\n  stats: { damage: \"1d4\" },\n};\nconst armor = equipment.find((e) => e.slot === \"body\") || {\n  name: \"Sem armadura\",\n  stats: { armor: 0 },\n};\nconst ac = storyData.armor_class || 10 + (armor.stats?.armor || 0);\n\n// =========================================\n// 4. MENSAGENS + DICE LAW\n// =========================================\nconst messages = storyData.messages || [];\n\nconst HISTORY_LIMIT = 10;\nconst historyRaw = messages.slice(-HISTORY_LIMIT);\n\nconst conversationHistory =\n  historyRaw.length > 0\n    ? historyRaw\n        .map((m) => {\n          const who = m.sender === \"player\" ? \"ðŸ§‘ JOGADOR\" : \"ðŸŽ² MESTRE\";\n          const body =\n            m.sender === \"player\"\n              ? m.content\n              : m.content?.length > 300\n                ? m.content.substring(0, 300) + \"â€¦\"\n                : m.content;\n          const rollTag = m.roll_result\n            ? ` [Dado: ${m.roll_result.total} vs DC${m.roll_result.difficulty} â†’ ${m.roll_result.success ? \"âœ…\" : \"âŒ\"}]`\n            : \"\";\n          return `${who}${rollTag}: ${body}`;\n        })\n        .join(\"\\n\")\n    : \"â€” InÃ­cio da conversa â€”\";\n\nconst lastPlayerMsgObj = messages\n  .slice()\n  .reverse()\n  .find((m) => m.sender === \"player\");\nconst lastPlayerMsg = lastPlayerMsgObj?.content || \"Olhar ao redor\";\n\nlet diceRaw = null;\nlet diceContext = \"\";\nlet diceOutcome = null;\n\nif (lastPlayerMsgObj?.roll_result) {\n  const r = lastPlayerMsgObj.roll_result;\n  diceRaw = r;\n  diceOutcome = r.success;\n  const label = r.success ? \"SUCESSO âœ…\" : \"FALHA âŒ\";\n  const crit = r.is_critical ? \" (CRÃTICO! ðŸŽ¯)\" : \"\";\n\n  diceContext = `[âš–ï¸ LEI DO DADO â€” OBRIGATÃ“RIO]\nRolagem: ${r.total} vs DC ${r.difficulty} â†’ ${label}${crit}\n${\n  r.success\n    ? \"â†’ Narre o SUCESSO e suas consequÃªncias positivas.\"\n    : \"â†’ Narre a FALHA com uma complicaÃ§Ã£o interessante, nÃ£o punitiva demais.\"\n}`;\n}\n\n// =========================================\n// 5. SISTEMAS RPG\n// =========================================\nconst rpgSystems = {\n  dnd: {\n    name: \"D&D 5e\",\n    tone: \"Fantasia Ã‰pica\",\n    skills: [\"Atletismo\", \"PercepÃ§Ã£o\", \"PersuasÃ£o\", \"Arcana\", \"Furtividade\", \"EnganaÃ§Ã£o\"],\n    dmgDie: \"d20\",\n    itemStyle: \"medieval-fantÃ¡stico\",\n  },\n  cyber: {\n    name: \"Cyberpunk Red\",\n    tone: \"High Tech Low Life\",\n    skills: [\"TÃ©cnica\", \"Reflexos\", \"Empatia\", \"Intelecto\", \"Corpo\", \"Frieza\"],\n    dmgDie: \"d10\",\n    itemStyle: \"high-tech corporativo\",\n  },\n  vampire: {\n    name: \"Vampire: Masquerade\",\n    tone: \"Horror GÃ³tico\",\n    skills: [\"Briga\", \"SubterfÃºgio\", \"ErudiÃ§Ã£o\", \"PresenÃ§a\", \"DominaÃ§Ã£o\", \"Animalismo\"],\n    dmgDie: \"d10\",\n    itemStyle: \"urbano-oculto\",\n  },\n  fallout: {\n    name: \"Fallout RPG\",\n    tone: \"PÃ³s-ApocalÃ­ptico\",\n    skills: [\"Armas Pesadas\", \"SobrevivÃªncia\", \"LÃ¡bia\", \"Medicina\", \"Furtividade\", \"Explosivos\"],\n    dmgDie: \"d8\",\n    itemStyle: \"sucata funcional\",\n  },\n};\nconst sys = rpgSystems[systemId] || rpgSystems.dnd;\n\n// =========================================\n// 6. DIFICULDADE\n// =========================================\nconst diffMap = {\n  easy:       { label: \"Narrativa\",   diffMod: -3, dmgMult: 0.7, lootMult: 1.3, xpMult: 0.8, goldMult: 1.2 },\n  normal:     { label: \"Equilibrado\", diffMod:  0, dmgMult: 1.0, lootMult: 1.0, xpMult: 1.0, goldMult: 1.0 },\n  hard:       { label: \"DifÃ­cil\",     diffMod: +3, dmgMult: 1.3, lootMult: 0.7, xpMult: 1.3, goldMult: 0.7 },\n  impossible: { label: \"Pesadelo\",    diffMod: +5, dmgMult: 1.5, lootMult: 0.5, xpMult: 1.5, goldMult: 0.5 },\n};\nconst diff = diffMap[difficulty] || diffMap.normal;\n\n// =========================================\n// 7. CALCULADORAS â€” XP e GOLD\n// =========================================\nconst XP_BASE = {\n  narrative: 20, combat: 60, loot: 35, rest: 0, levelup: 0,\n  travel: 25, moral: 30, craft: 40, consequences: 35, commerce: 10,\n};\nconst xpBase = XP_BASE[detectedMode] || 20;\nconst xpMin = Math.round(xpBase * 0.7 * diff.xpMult);\nconst xpMax = Math.round(xpBase * 1.3 * diff.xpMult);\n\nconst GOLD_BASE = {\n  narrative: 0,\n  combat:       Math.round(level * 5  * diff.goldMult),\n  loot:         Math.round(level * 15 * diff.goldMult),\n  rest: 0, levelup: 0,\n  travel:       Math.round(level * 3  * diff.goldMult),\n  moral: 0,\n  craft:       -Math.round(level * 2),\n  consequences: 0,\n  commerce:     0,\n};\nconst goldDeltaBase = GOLD_BASE[detectedMode] || 0;\n\n// =========================================\n// 7b. STATUS EFFECTS â€” processar antes do turno\n// =========================================\nconst statusSummary = statusEffects.reduce(\n  (acc, ef) => {\n    if (typeof ef.hp_per_turn === \"number\") acc.hpDelta  += ef.hp_per_turn;\n    if (typeof ef.atk_bonus   === \"number\") acc.atkBonus += ef.atk_bonus;\n    if (typeof ef.def_bonus   === \"number\") acc.defBonus += ef.def_bonus;\n    return acc;\n  },\n  { hpDelta: 0, atkBonus: 0, defBonus: 0 },\n);\n\nconst hpAfterEffects = Math.max(0, Math.min(hpMax, hpCurrent + statusSummary.hpDelta));\nconst acEffective    = ac + statusSummary.defBonus;\n\nconst expiringEffects  = statusEffects.filter((ef) => ef.turns_remaining === 1);\nconst remainingEffects = statusEffects\n  .filter((ef) => ef.turns_remaining > 1)\n  .map((ef) => ({ ...ef, turns_remaining: ef.turns_remaining - 1 }));\n\nconst statusContext =\n  statusEffects.length > 0\n    ? statusEffects\n        .map((ef) => {\n          const parts = [`âš¡ ${ef.label} (${ef.turns_remaining} turno(s)) â€” fonte: ${ef.source}`];\n          if (ef.hp_per_turn) parts.push(`${ef.hp_per_turn > 0 ? \"+\" : \"\"}${ef.hp_per_turn} HP/turno`);\n          if (ef.atk_bonus)   parts.push(`${ef.atk_bonus > 0   ? \"+\" : \"\"}${ef.atk_bonus} ataque`);\n          if (ef.def_bonus)   parts.push(`${ef.def_bonus > 0   ? \"+\" : \"\"}${ef.def_bonus} defesa`);\n          return parts.join(\" | \");\n        })\n        .join(\"\\n\")\n    : null;\n\n// =========================================\n// 7c. WORLD FLAGS â€” formatar para contexto\n// =========================================\nconst worldFlagsContext =\n  worldFlags.length > 0\n    ? worldFlags\n        .map((f) => {\n          const val =\n            typeof f.flag_value === \"object\"\n              ? JSON.stringify(f.flag_value)\n              : String(f.flag_value);\n          return `  â€¢ ${f.flag_key}: ${val}`;\n        })\n        .join(\"\\n\")\n    : null;\n\n// =========================================\n// 8. MOTOR DE COMBATE â€” 100% em JavaScript\n// =========================================\nfunction rollDie(sides) {\n  return Math.floor(Math.random() * sides) + 1;\n}\n\nfunction parseDamage(diceStr) {\n  if (!diceStr || typeof diceStr !== \"string\") return { num: 1, sides: 4, bonus: 0 };\n  const match = diceStr.match(/^(\\d+)d(\\d+)([+-]\\d+)?$/i);\n  if (!match) return { num: 1, sides: 4, bonus: 0 };\n  return {\n    num:   parseInt(match[1]),\n    sides: parseInt(match[2]),\n    bonus: match[3] ? parseInt(match[3]) : 0,\n  };\n}\n\nfunction rollDamage(diceStr, isCritical, multiplier) {\n  const { num, sides, bonus } = parseDamage(diceStr);\n  const dice = isCritical ? num * 2 : num;\n  let total = bonus;\n  for (let i = 0; i < dice; i++) total += rollDie(sides);\n  return Math.max(1, Math.round(total * multiplier));\n}\n\nfunction parseEnemyHp(npcStr) {\n  const match = npcStr.match(/\\[HP:(\\d+)\\/(\\d+)\\]/);\n  if (match) return { current: parseInt(match[1]), max: parseInt(match[2]) };\n  const base = 10 + level * 5;\n  const hp = base + rollDie(6) - 3;\n  return { current: hp, max: hp };\n}\n\nfunction encodeEnemyHp(name, hp) {\n  const cleanName = name.replace(/\\s*\\[HP:\\d+\\/\\d+\\]/, \"\").trim();\n  return `${cleanName} [HP:${hp.current}/${hp.max}]`;\n}\n\nconst ALLY_KEYWORDS = [\"aliado\", \"companheiro\", \"membro do grupo\", \"parceiro\"];\nconst hostileNPCs = activeNPCs.filter((npc) => {\n  const lower = npc.toLowerCase();\n  if (lower.includes(\"hp:0/\")) return false;\n  return !ALLY_KEYWORDS.some((k) => lower.includes(k));\n});\n\nconst targetRaw = (() => {\n  if (combatTargetDB) {\n    const found = hostileNPCs.find(\n      (npc) =>\n        npc.replace(/\\s*\\[HP:\\d+\\/\\d+\\]/, \"\").trim() ===\n        combatTargetDB.replace(/\\s*\\[HP:\\d+\\/\\d+\\]/, \"\").trim(),\n    );\n    if (found) return found;\n  }\n  return hostileNPCs[0] || null;\n})();\n\nconst targetHp   = targetRaw ? parseEnemyHp(targetRaw) : null;\nconst targetName = targetRaw ? targetRaw.replace(/\\s*\\[HP:\\d+\\/\\d+\\]/, \"\").trim() : \"Inimigo\";\n\nlet combatResult = null;\n\nif ((detectedMode === \"combat\" || inCombatDB) && diceRaw) {\n  const playerHit    = diceRaw.success    ?? false;\n  const isCritical   = diceRaw.is_critical ?? false;\n  const weaponDiceStr = weapon.stats?.damage || \"1d4\";\n\n  const playerDamage = playerHit\n    ? rollDamage(weaponDiceStr, isCritical, diff.dmgMult) + statusSummary.atkBonus\n    : 0;\n\n  const enemyHpAfter = targetHp\n    ? Math.max(0, targetHp.current - Math.max(0, playerDamage))\n    : null;\n  const targetDied = targetHp !== null && enemyHpAfter <= 0;\n\n  const enemyAtkBonus = Math.max(1, Math.floor(level / 2));\n  const enemyDiceStr  = `${Math.max(1, Math.floor(level / 2))}d6`;\n\n  let totalPlayerDamageTaken = 0;\n  const enemyTurns = hostileNPCs.map((npcStr) => {\n    const npcName = npcStr.replace(/\\s*\\[HP:\\d+\\/\\d+\\]/, \"\").trim();\n\n    if (npcName === targetName && targetDied) {\n      return { name: npcName, roll: 0, total: 0, hit: false, damage: 0, skipped: true };\n    }\n\n    const roll   = rollDie(20);\n    const total  = roll + enemyAtkBonus;\n    const hit    = total >= acEffective;\n    const damage = hit ? rollDamage(enemyDiceStr, false, diff.dmgMult) : 0;\n\n    if (hit) totalPlayerDamageTaken += damage;\n\n    return { name: npcName, roll, total, hit, damage, skipped: false };\n  });\n\n  const playerHpAfter = Math.max(0, hpAfterEffects - totalPlayerDamageTaken);\n\n  const updatedNPCs = activeNPCs.map((npc) => {\n    const cleanNpc = npc.replace(/\\s*\\[HP:\\d+\\/\\d+\\]/, \"\").trim();\n    if (cleanNpc === targetName && targetHp) {\n      return encodeEnemyHp(cleanNpc, { current: enemyHpAfter, max: targetHp.max });\n    }\n    return npc;\n  });\n\n  const deadNPCs         = targetDied ? [targetName] : [];\n  const remainingHostile = hostileNPCs.length - deadNPCs.length;\n\n  combatResult = {\n    player: {\n      roll:     diceRaw.roll  ?? 0,\n      total:    diceRaw.total ?? 0,\n      hit:      playerHit,\n      damage:   Math.max(0, playerDamage),\n      critical: isCritical,\n      target:   targetName,\n    },\n    enemyTurns,\n    totalPlayerDamageTaken,\n    enemyHpBefore:    targetHp?.current ?? 0,\n    enemyHpAfter:     enemyHpAfter      ?? 0,\n    enemyMaxHp:       targetHp?.max     ?? 0,\n    targetDied,\n    playerHpAfter,\n    playerDamageTaken: totalPlayerDamageTaken,\n    totalHpDelta:      playerHpAfter - hpCurrent,\n    updatedNPCs,\n    deadNPCs,\n    remainingHostile,\n    allEnemiesDead: remainingHostile <= 0 && hostileNPCs.length > 0,\n    goldDropped:    targetDied ? Math.round(level * 5 * diff.goldMult) : 0,\n    statusAfterTurn: remainingEffects,\n    expiringEffects,\n  };\n}\n\nconst combatLogBlock = combatResult\n  ? JSON.stringify(\n      {\n        combat_log: {\n          player_attack: {\n            roll:     combatResult.player.roll,\n            total:    combatResult.player.total,\n            hit:      combatResult.player.hit,\n            damage:   combatResult.player.damage,\n            critical: combatResult.player.critical,\n            target:   combatResult.player.target,\n          },\n          enemy_turns:        combatResult.enemyTurns,\n          enemy_hp_before:    combatResult.enemyHpBefore,\n          enemy_hp_remaining: combatResult.enemyHpAfter,\n          enemy_max_hp:       combatResult.enemyMaxHp,\n          target_died:        combatResult.targetDied,\n          total_damage_taken: combatResult.totalPlayerDamageTaken,\n        },\n      },\n      null,\n      2,\n    )\n      .replace(/^{/, \"\")\n      .replace(/}$/, \"\")\n      .trim()\n  : `\"combat_log\": {\n    \"player_attack\": {\"roll\":0,\"total\":0,\"hit\":false,\"damage\":0,\"critical\":false,\"target\":\"\"},\n    \"enemy_turns\": [],\n    \"enemy_hp_before\":0,\"enemy_hp_remaining\":0,\"enemy_max_hp\":0,\n    \"target_died\":false,\"total_damage_taken\":0\n  }`;\n\n// =========================================\n// 9. INVENTÃRIO FILTRADO\n// =========================================\nconst INV_LIMIT = 20;\n\nfunction buildInventoryContext(inv) {\n  if (inv.length === 0) return \"  â€¢ Vazio\";\n  if (inv.length <= INV_LIMIT) {\n    return inv.map((i) => `  â€¢ ${i.name} (${i.quantity}x)`).join(\"\\n\");\n  }\n  const consumables = inv.filter((i) => i.type === \"consumable\").slice(0, 8);\n  const gear = inv.filter((i) => i.type === \"weapon\" || i.type === \"armor\").slice(0, 5);\n  const others = inv.length - consumables.length - gear.length;\n  const lines = [\n    \"  [CONSUMÃVEIS]\",\n    ...consumables.map((i) => `  â€¢ ${i.name} (${i.quantity}x)`),\n    \"  [ARMAS & ARMADURAS]\",\n    ...gear.map((i) => `  â€¢ ${i.name}`),\n    `  [+ ${others} itens diversos nÃ£o listados]`,\n  ];\n  return lines.join(\"\\n\");\n}\n\nconst inventoryContext = buildInventoryContext(inventory);\n\n// =========================================\n// 10. REGRAS GLOBAIS\n// =========================================\nconst MASTER_RULES = `\nREGRAS GLOBAIS (valem para todos os modos):\nâ€¢ JSON vÃ¡lido â€” sem texto fora do objeto.\nâ€¢ \"narrative\" usa \\\\n\\\\n entre parÃ¡grafos.\nâ€¢ \"xp_awarded\" deve ser um nÃºmero entre ${xpMin} e ${xpMax}.\nâ€¢ \"gold_change\" deve refletir ganho/perda real (pode ser negativo).\nâ€¢ \"delta_updates.inventory\" usa {\"add\":[...],\"remove\":[...]} â€” nunca substitua o array todo.\nâ€¢ \"active_npcs_update\" usa {\"add\":[...],\"remove\":[...]} com nomes como strings SEM o [HP:x/x].\nâ€¢ \"world_flags_update\" usa {\"set\":{\"flag_key\": valor},\"delete\":[\"flag_key\"]} â€” sÃ³ preencha se houver mudanÃ§a real no estado do mundo.\nâ€¢ \"status_effects_update\" usa {\"add\":[...],\"remove\":[\"id\"]} â€” sÃ³ preencha se houver novo efeito ou remoÃ§Ã£o.\nâ€¢ LEI DO DADO tem prioridade absoluta sobre qualquer outra lÃ³gica narrativa.\n`.trim();\n\n// =========================================\n// 11. CONTEXTO COMUM\n// FIX: NPCs exibidos COM HP para a IA\n// =========================================\nconst commonContext = `\nPERSONAGEM: ${charName} | ${className} Nv${level} | HP ${hpAfterEffects}/${hpMax} | CA ${acEffective} | ${gold}g\nXP: ${experience}/${nextLevelXp} | Sistema: ${sys.name} | Dificuldade: ${diff.label}\nLOCAL: ${currentLocation}\nNPCs: ${activeNPCs.length > 0 ? activeNPCs.join(\", \") : \"Nenhum\"}\nMISSÃ•ES: ${activeQuests.length > 0 ? activeQuests.join(\" | \") : \"Nenhuma\"}\nARMA: ${weapon.name} (${weapon.stats?.damage || \"1d4\"}) | ARMADURA: ${armor.name}\nEQUIPADO: ${equipment.length > 0 ? equipment.map((e) => `${e.slot}: ${e.name}`).join(\" | \") : \"Nenhum equipamento\"}\n${inCombatDB ? `âš”ï¸ EM COMBATE: ${combatTargetDB ? combatTargetDB.replace(/\\s*\\[HP:\\d+\\/\\d+\\]/, \"\") : \"inimigo desconhecido\"}` : \"\"}\n${statusContext ? `\\nEFEITOS ATIVOS:\\n${statusContext}` : \"\"}\n${statusSummary.hpDelta !== 0 ? `âš ï¸ HP ajustado por efeitos passivos: ${hpCurrent} â†’ ${hpAfterEffects} (${statusSummary.hpDelta > 0 ? \"+\" : \"\"}${statusSummary.hpDelta}/turno)` : \"\"}\nINVENTÃRIO:\n${inventoryContext}\nRESUMO: ${lastSnippet}\n${worldFlagsContext ? `\\nESTADO DO MUNDO:\\n${worldFlagsContext}` : \"\"}\nHISTÃ“RICO RECENTE (${historyRaw.length} mensagens):\n${conversationHistory}\n`.trim();\n\n// =========================================\n// 12. TEMPLATES DE PROMPT\n// =========================================\nconst prompts = {\n  narrative: {\n    persona: `VocÃª Ã© O BARDO de ${sys.name} (${sys.tone}). Crie atmosfera com os 5 sentidos. Interprete NPCs com agenda prÃ³pria. Revele pistas atravÃ©s de diÃ¡logo. Nunca force combate desnecessÃ¡rio.`,\n    instructions: `MODO: NARRATIVA\n${commonContext}\nAÃ‡ÃƒO: \"${lastPlayerMsg}\"\n${diceContext ? diceContext + \"\\n\" : \"\"}\n${MASTER_RULES}\n\nREGRAS DO MODO:\n1. MÃ­n. 3 parÃ¡grafos sensoriais. Tom: ${sys.tone}.\n2. Dado presente? ${diceOutcome === null ? \"Narre livremente.\" : diceOutcome ? \"SUCESSO â†’ consequÃªncias positivas.\" : \"FALHA â†’ complicaÃ§Ã£o interessante.\"}\n3. gold_change: 0 a menos que NPC pague ou jogador venda algo.\n4. location_update: preencha se o jogador mudar de local.\n\nSCHEMA JSON:\n{\n  \"narrative\": \"...\",\n  \"choices\": [\n    {\"text\":\"Investigar\",\"type\":\"investigate\",\"skillCheck\":\"${sys.skills[1]}\",\"difficulty\":${12 + diff.diffMod},\"diceType\":\"d20\"},\n    {\"text\":\"Persuadir NPC\",\"type\":\"social\",\"skillCheck\":\"${sys.skills[2]}\",\"difficulty\":${13 + diff.diffMod},\"diceType\":\"d20\"},\n    {\"text\":\"AÃ§Ã£o fÃ­sica\",\"type\":\"action\",\"skillCheck\":\"${sys.skills[0]}\",\"difficulty\":${14 + diff.diffMod},\"diceType\":\"d20\"},\n    {\"text\":\"Observar\",\"type\":\"stealth\"}\n  ],\n  \"delta_updates\": {\n    \"hp_change\": 0,\n    \"xp_awarded\": NÃšMERO_ENTRE_${xpMin}_E_${xpMax},\n    \"gold_change\": 0,\n    \"inventory\": {\"add\":[],\"remove\":[]},\n    \"active_npcs_update\": {\"add\":[],\"remove\":[]},\n    \"location_update\": \"\",\n    \"active_quests_update\": {\"add\":[],\"remove\":[]},\n    \"in_combat\": false,\n    \"combat_target\": null,\n    \"status_effects_update\": {\"add\":[],\"remove\":[]},\n    \"world_flags_update\": {\"set\":{},\"delete\":[]}\n  },\n  \"metadata\": {\"mood\":\"\",\"time_of_day\":\"\",\"discovered_info\":\"\"}\n}`,\n  },\n\n  combat: {\n    persona: `VocÃª Ã© O JUIZ de ${sys.name}. Narrador de combate â€” todos os nÃºmeros JÃ foram calculados pelo sistema. Sua Ãºnica funÃ§Ã£o Ã© criar a narrativa visceral baseada nos resultados fornecidos. MÃ¡x 2 parÃ¡grafos. Tom: ${sys.tone}.`,\n    instructions: `MODO: COMBATE\n${commonContext}\nAÃ‡ÃƒO: \"${lastPlayerMsg}\"\n${diceContext ? diceContext + \"\\n\" : \"\"}\n${MASTER_RULES}\n\nâš ï¸ TODOS OS NÃšMEROS JÃ FORAM CALCULADOS. NÃƒO INVENTE VALORES. USE OS FORNECIDOS ABAIXO:\n\n${\n  combatResult\n    ? `RESULTADO DO TURNO (calculado pelo backend):\nâ–¶ JOGADOR atacou ${targetName}: ${combatResult.player.hit ? `ACERTOU â€” ${combatResult.player.damage} de dano${combatResult.player.critical ? \" (CRÃTICO!)\" : \"\"}` : \"ERROU\"}\nâ–¶ ${targetName} HP: ${combatResult.enemyHpBefore} â†’ ${combatResult.enemyHpAfter}/${combatResult.enemyMaxHp}${combatResult.targetDied ? \" â€” MORTO â˜ ï¸\" : \"\"}\n${combatResult.enemyTurns\n  .filter((e) => !e.skipped)\n  .map((e) => `â–¶ ${e.name} contra-atacou: ${e.hit ? `ACERTOU â€” ${e.damage} de dano no jogador` : \"ERROU\"}`)\n  .join(\"\\n\")}\nâ–¶ JOGADOR HP: ${hpCurrent} â†’ ${combatResult.playerHpAfter}/${hpMax} (total recebido: ${combatResult.totalPlayerDamageTaken})\n${combatResult.targetDied ? `â–¶ OURO DROPADO: ${combatResult.goldDropped}g` : \"\"}\n${hostileNPCs.length > 1 ? `â–¶ INIMIGOS RESTANTES: ${hostileNPCs.length - combatResult.deadNPCs.length}/${hostileNPCs.length}` : \"\"}`\n    : \"Sem dado ativo â€” narre aÃ§Ã£o de preparaÃ§Ã£o/iniciativa.\"\n}\n\nSUA TAREFA:\nEscreva a narrativa visceral deste turno. Mencione cada inimigo que atacou.\n${combatResult?.playerHpAfter <= 0 ? \"âš ï¸ HP DO JOGADOR CHEGOU A 0 â€” narre derrota/morte com dignidade.\" : \"\"}\n${combatResult?.targetDied ? `âš ï¸ ${targetName} MORREU â€” narre a vitÃ³ria e mencione o corpo que pode ser saqueado.` : \"\"}\n${combatResult?.allEnemiesDead ? \"âš ï¸ TODOS OS INIMIGOS FORAM ELIMINADOS â€” narre o fim do combate.\" : \"\"}\n\nSCHEMA JSON (valores fixados pelo backend â€” NÃƒO altere hp_change, gold_change nem active_npcs_update):\n{\n  \"narrative\": \"NarraÃ§Ã£o visceral do turno...\",\n  ${combatLogBlock},\n  \"choices\": [\n    {\"text\":\"Atacar ${targetName || \"inimigo\"}\",\"type\":\"action\",\"skillCheck\":\"${sys.skills[0]}\",\"difficulty\":${12 + diff.diffMod},\"diceType\":\"d20\"},\n    {\"text\":\"Usar habilidade especial\",\"type\":\"action\",\"skillCheck\":\"${sys.skills[1]}\",\"difficulty\":${15 + diff.diffMod},\"diceType\":\"d20\"},\n    {\"text\":\"Usar item do inventÃ¡rio\",\"type\":\"action\"},\n    {\"text\":\"Fugir do combate\",\"type\":\"stealth\",\"skillCheck\":\"${sys.skills[4]}\",\"difficulty\":${14 + diff.diffMod},\"diceType\":\"d20\"}\n  ],\n  \"delta_updates\": {\n    \"hp_change\": ${combatResult ? combatResult.totalHpDelta : 0},\n    \"xp_awarded\": NÃšMERO_ENTRE_${xpMin}_E_${xpMax},\n    \"gold_change\": ${combatResult?.targetDied ? combatResult.goldDropped : 0},\n    \"inventory\": {\"add\":[],\"remove\":[]},\n    \"active_npcs_update\": {\n      \"add\": [],\n      \"remove\": ${combatResult?.deadNPCs?.length ? JSON.stringify(combatResult.deadNPCs) : \"[]\"}\n    },\n    \"in_combat\": ${combatResult?.allEnemiesDead || combatResult?.playerHpAfter <= 0 ? false : true},\n    \"combat_target\": ${combatResult?.allEnemiesDead || combatResult?.targetDied ? \"null\" : `\"${targetName}\"`},\n    \"status_effects_update\": {\"add\":[],\"remove\":${JSON.stringify(expiringEffects.map((e) => e.id))}},\n    \"world_flags_update\": {\"set\":{},\"delete\":[]}\n  },\n  \"metadata\": {\n    \"in_combat\": ${combatResult?.allEnemiesDead ? false : combatResult?.playerHpAfter <= 0 ? false : true},\n    \"combat_status\": \"${combatResult?.allEnemiesDead ? \"victory\" : combatResult?.playerHpAfter <= 0 ? \"defeat\" : \"ongoing\"}\",\n    \"enemies_remaining\": ${hostileNPCs.length - (combatResult?.deadNPCs?.length || 0)},\n    \"effects_expired\": ${JSON.stringify(expiringEffects.map((e) => e.label))}\n  }\n}`,\n  },\n\n  loot: {\n    persona: `VocÃª Ã© O TESOUREIRO de ${sys.name}. Itens no estilo \"${sys.itemStyle}\". Nomes Ãºnicos com flavor text. NÃ­vel ${level} Ã— mult ${diff.lootMult}. Sem lendÃ¡rios antes do nÃ­vel 5.`,\n    instructions: `MODO: LOOT\n${commonContext}\nAÃ‡ÃƒO: \"${lastPlayerMsg}\"\n${MASTER_RULES}\n\nREGRAS DO MODO:\n1. 1-3 itens. 60% consumÃ­vel, 30% arma/armadura, 10% especial.\n2. Nomes Ãºnicos â€” nÃ£o \"Espada +1\", use \"LÃ¢mina do Guarda CaÃ­do\".\n3. gold_change: ${goldDeltaBase} ouro base (ajuste pelo contexto do baÃº/corpo).\n4. Itens do inventÃ¡rio atual NÃƒO podem ser duplicados.\n5. \"type\" sÃ³ aceita: consumable | weapon | armor | misc\n6. Itens equipÃ¡veis (weapon/armor) DEVEM ter em effect_data:\n   - \"is_equippable\": true\n   - \"equip_slot\": slot vÃ¡lido (main_hand | body | head | legs | off_hand | accessory)\n   - \"icon\": emoji representando o item\n   - stats relevantes: \"damage\" para armas, \"armor\" para armaduras\n\nSCHEMA JSON:\n{\n  \"narrative\": \"...\",\n  \"choices\": [\n    {\"text\":\"Pegar tudo\",\"type\":\"action\"},\n    {\"text\":\"Inspecionar itens\",\"type\":\"investigate\",\"skillCheck\":\"${sys.skills[1]}\",\"difficulty\":${10 + diff.diffMod},\"diceType\":\"d20\"},\n    {\"text\":\"Pegar o melhor\",\"type\":\"action\"},\n    {\"text\":\"Deixar e seguir\",\"type\":\"action\"}\n  ],\n  \"delta_updates\": {\n    \"hp_change\": 0,\n    \"xp_awarded\": NÃšMERO_ENTRE_${xpMin}_E_${xpMax},\n    \"gold_change\": NÃšMERO_POSITIVO_BASEADO_NO_CONTEXTO,\n    \"inventory\": {\n      \"add\": [\n        {\"name\":\"Exemplo ConsumÃ­vel\",\"description\":\"DescriÃ§Ã£o.\",\"quantity\":1,\"type\":\"consumable\",\"effect_data\":{\"heal\":10,\"is_equippable\":false},\"value\":15},\n        {\"name\":\"Exemplo Arma\",\"description\":\"DescriÃ§Ã£o.\",\"quantity\":1,\"type\":\"weapon\",\"effect_data\":{\"is_equippable\":true,\"equip_slot\":\"main_hand\",\"damage\":\"1d8\",\"icon\":\"âš”ï¸\"},\"value\":50},\n        {\"name\":\"Exemplo Armadura\",\"description\":\"DescriÃ§Ã£o.\",\"quantity\":1,\"type\":\"armor\",\"effect_data\":{\"is_equippable\":true,\"equip_slot\":\"body\",\"armor\":3,\"icon\":\"ðŸ›¡ï¸\"},\"value\":40}\n      ],\n      \"remove\": []\n    },\n    \"active_npcs_update\": {\"add\":[],\"remove\":[]}\n  },\n  \"metadata\": {\"loot_source\":\"\",\"loot_quality\":\"poor|average|good|excellent\"}\n}`,\n  },\n\n  rest: {\n    persona: `VocÃª Ã© O CURANDEIRO de ${sys.name}. Gerencie recuperaÃ§Ã£o e crie eventos de descanso memorÃ¡veis. Em Ã¡reas hostis, descansos podem ser interrompidos.`,\n    instructions: `MODO: DESCANSO\n${commonContext}\nAÃ‡ÃƒO: \"${lastPlayerMsg}\"\n${MASTER_RULES}\n\nREGRAS DO MODO:\nâ€¢ Curto (1h): hp_change = +${Math.floor(hpMax * 0.25)} (25% HP Max)\nâ€¢ Longo (8h): hp_change = +${hpMax - hpCurrent} (HP completo)\nâ€¢ Dificuldade \"${difficulty}\": ${difficulty === \"hard\" || difficulty === \"impossible\" ? \"50% chance de interrupÃ§Ã£o â€” role narrativamente.\" : \"Descanso seguro.\"}\nâ€¢ 30% chance de evento especial (sonho, conversa, barulho).\nâ€¢ xp_awarded: sempre 0.\n\nSCHEMA JSON:\n{\n  \"narrative\": \"...\",\n  \"choices\": [\n    {\"text\":\"Retomar jornada\",\"type\":\"action\"},\n    {\"text\":\"Conversar com aliados\",\"type\":\"social\"},\n    {\"text\":\"Estudar/preparar\",\"type\":\"investigate\"},\n    {\"text\":\"Montar vigÃ­lia\",\"type\":\"stealth\"}\n  ],\n  \"delta_updates\": {\n    \"hp_change\": NÃšMERO_POSITIVO_VEJA_REGRAS,\n    \"xp_awarded\": 0,\n    \"gold_change\": 0,\n    \"inventory\": {\"add\":[],\"remove\":[]},\n    \"active_npcs_update\": {\"add\":[],\"remove\":[]}\n  },\n  \"metadata\": {\"rest_type\":\"short|long\",\"rest_quality\":\"poor|average|good\",\"interrupted\":false,\"time_passed\":\"\",\"event\":\"\"}\n}`,\n  },\n\n  levelup: {\n    persona: `VocÃª Ã© O MENTOR. O herÃ³i evoluiu. OfereÃ§a 3 escolhas mecÃ¢nicas claras para ${className} em ${sys.name}. Celebre o momento narrativamente.`,\n    instructions: `MODO: LEVEL UP\n${commonContext}\nXP: ${experience} / ${nextLevelXp} â†’ NÃ­vel ${level} â†’ ${level + 1}\n${MASTER_RULES}\n\nREGRAS DO MODO:\n1. Narre a epifania ou treinamento.\n2. 3 escolhas com efeito mecÃ¢nico EXPLÃCITO (ex: \"+2 dano\", \"nova perÃ­cia\", \"+10 HP Max\").\n3. hp_change = 9999 (restaura HP total).\n4. gold_change = 0.\n5. xp_awarded = 0.\n\nSCHEMA JSON:\n{\n  \"narrative\": \"...\",\n  \"level_up_choices\": [\n    {\"id\":\"a1\",\"name\":\"\",\"description\":\"Efeito mecÃ¢nico claro\",\"category\":\"combat|utility|social|magic\"},\n    {\"id\":\"a2\",\"name\":\"\",\"description\":\"\",\"category\":\"\"},\n    {\"id\":\"a3\",\"name\":\"\",\"description\":\"\",\"category\":\"\"}\n  ],\n  \"choices\": [\n    {\"text\":\"Escolher opÃ§Ã£o 1\",\"type\":\"action\",\"choice_ref\":\"a1\"},\n    {\"text\":\"Escolher opÃ§Ã£o 2\",\"type\":\"action\",\"choice_ref\":\"a2\"},\n    {\"text\":\"Escolher opÃ§Ã£o 3\",\"type\":\"action\",\"choice_ref\":\"a3\"}\n  ],\n  \"delta_updates\": {\n    \"hp_change\": 9999,\n    \"xp_awarded\": 0,\n    \"gold_change\": 0,\n    \"inventory\": {\"add\":[],\"remove\":[]},\n    \"active_npcs_update\": {\"add\":[],\"remove\":[]}\n  },\n  \"metadata\": {\"previous_level\":${level},\"new_level\":${level + 1},\"hp_max_increase\":10,\"choice_pending\":true}\n}`,\n  },\n\n  travel: {\n    persona: `VocÃª Ã© O CARTÃ“GRAFO de ${sys.name} (${sys.tone}). Crie sensaÃ§Ã£o de mundo vasto. Gere encontros variados. Revelie lore atravÃ©s da paisagem.`,\n    instructions: `MODO: VIAGEM\n${commonContext}\nAÃ‡ÃƒO: \"${lastPlayerMsg}\"\n${MASTER_RULES}\n\nREGRAS DO MODO:\n1. Descreva paisagem, clima e sensaÃ§Ãµes da estrada.\n2. 50% chance de encontro (viajante, ruÃ­na, criatura, evento).\n3. gold_change: ${goldDeltaBase} (comÃ©rcio de estrada â€” pode ser 0 se sem encontro).\n4. location_update: obrigatÃ³rio com o novo destino ou ponto intermediÃ¡rio.\n\nSCHEMA JSON:\n{\n  \"narrative\": \"...\",\n  \"choices\": [\n    {\"text\":\"Investigar ponto de interesse\",\"type\":\"investigate\",\"skillCheck\":\"${sys.skills[1]}\",\"difficulty\":${12 + diff.diffMod},\"diceType\":\"d20\"},\n    {\"text\":\"Continuar marcha\",\"type\":\"action\"},\n    {\"text\":\"Acampar\",\"type\":\"rest\"},\n    {\"text\":\"Rota alternativa\",\"type\":\"stealth\"}\n  ],\n  \"delta_updates\": {\n    \"hp_change\": 0,\n    \"xp_awarded\": NÃšMERO_ENTRE_${xpMin}_E_${xpMax},\n    \"gold_change\": NÃšMERO_BASEADO_NO_ENCONTRO,\n    \"inventory\": {\"add\":[],\"remove\":[]},\n    \"active_npcs_update\": {\"add\":[],\"remove\":[]},\n    \"location_update\": \"NOVO_LOCAL_OBRIGATÃ“RIO\"\n  },\n  \"metadata\": {\"distance_traveled\":\"\",\"time_passed\":\"\",\"weather\":\"\",\"encounter_occurred\":false}\n}`,\n  },\n\n  moral: {\n    persona: `VocÃª Ã© O FILÃ“SOFO de ${sys.name}. Apresente dilemas sem resposta correta. Nunca julgue a escolha do jogador. ConsequÃªncias a longo prazo sÃ£o sua especialidade.`,\n    instructions: `MODO: DILEMA MORAL\n${commonContext}\nSITUAÃ‡ÃƒO: \"${lastPlayerMsg}\"\n${MASTER_RULES}\n\nREGRAS DO MODO:\n1. MÃ­n. 2 lados legÃ­timos com custo E benefÃ­cio real em cada.\n2. Nenhuma opÃ§Ã£o Ã© claramente \"certa\".\n3. Terceira via criativa Ã© sempre possÃ­vel, mas difÃ­cil.\n4. gold_change: 0 a menos que o dilema envolva transaÃ§Ã£o.\n\nSCHEMA JSON:\n{\n  \"narrative\": \"...\",\n  \"choices\": [\n    {\"text\":\"OpÃ§Ã£o A\",\"type\":\"moral_choice\",\"consequence_hint\":\"ConsequÃªncia de curto prazo.\"},\n    {\"text\":\"OpÃ§Ã£o B\",\"type\":\"moral_choice\",\"consequence_hint\":\"ConsequÃªncia alternativa.\"},\n    {\"text\":\"Terceira via (difÃ­cil)\",\"type\":\"action\",\"skillCheck\":\"${sys.skills[2]}\",\"difficulty\":${16 + diff.diffMod},\"diceType\":\"d20\"}\n  ],\n  \"delta_updates\": {\n    \"hp_change\": 0,\n    \"xp_awarded\": NÃšMERO_ENTRE_${xpMin}_E_${xpMax},\n    \"gold_change\": 0,\n    \"inventory\": {\"add\":[],\"remove\":[]},\n    \"active_npcs_update\": {\"add\":[],\"remove\":[]}\n  },\n  \"metadata\": {\"dilemma_type\":\"justice|mercy|sacrifice|loyalty|truth\",\"stakes\":\"personal|local|regional|world\"}\n}`,\n  },\n\n  craft: {\n    persona: `VocÃª Ã© O ARTESÃƒO de ${sys.name}. Verifique materiais. Resultados graduados: sucesso total, parcial ou falha. Itens com nomes Ãºnicos.`,\n    instructions: `MODO: CRAFTING\n${commonContext}\nAÃ‡ÃƒO: \"${lastPlayerMsg}\"\n${diceContext ? diceContext + \"\\n\" : \"\"}\n${MASTER_RULES}\n\nREGRAS DO MODO:\n1. Verifique se materiais existem no inventÃ¡rio listado.\n2. Teste: ${sys.skills[1]} vs DC pela complexidade do item.\n3. Sucesso total: item perfeito. Parcial: funcional, -50% stats. Falha: 50% materiais perdidos.\n4. gold_change: ${goldDeltaBase} (craft gasta materiais â€” valor negativo quando aplicÃ¡vel).\n5. XP de crafting proporcional Ã  complexidade.\n6. \"type\" sÃ³ aceita: consumable | weapon | armor | misc\n\nSCHEMA JSON:\n{\n  \"narrative\": \"...\",\n  \"choices\": [\n    {\"text\":\"Criar outro item\",\"type\":\"action\"},\n    {\"text\":\"Testar o item\",\"type\":\"investigate\"},\n    {\"text\":\"Guardar e sair\",\"type\":\"action\"}\n  ],\n  \"delta_updates\": {\n    \"hp_change\": 0,\n    \"xp_awarded\": NÃšMERO_ENTRE_${xpMin}_E_${xpMax},\n    \"gold_change\": NÃšMERO_NEGATIVO_SE_MATERIAIS_CUSTAM_GOLD,\n    \"inventory\": {\"add\":[],\"remove\":[]},\n    \"active_npcs_update\": {\"add\":[],\"remove\":[]}\n  },\n  \"metadata\": {\"craft_result\":\"success|partial|failure\",\"time_spent\":\"\",\"materials_wasted\":[]}\n}`,\n  },\n\n  consequences: {\n    persona: `VocÃª Ã© O CRONISTA de ${sys.name}. FaÃ§a o mundo reagir Ã s aÃ§Ãµes do jogador. Ripple effects consistentes. Atualize facÃ§Ãµes, locais e NPCs.`,\n    instructions: `MODO: CONSEQUÃŠNCIAS\n${commonContext}\nAÃ‡Ã•ES RELEVANTES: \"${lastPlayerMsg}\"\n${MASTER_RULES}\n\nREGRAS DO MODO:\n1. Pelo menos 1 NPC ou local deve ter sofrido impacto real.\n2. ConsequÃªncias podem ser positivas ou negativas.\n3. gold_change: 0 a menos que reputaÃ§Ã£o gere pagamento/perda.\n4. location_update: preencha se o impacto mudar onde o jogador pode ir.\n\nSCHEMA JSON:\n{\n  \"narrative\": \"...\",\n  \"world_state_updates\": {\n    \"locations_changed\": [],\n    \"npcs_affected\": [],\n    \"factions_reputation\": {}\n  },\n  \"choices\": [\n    {\"text\":\"Continuar aventura\",\"type\":\"action\"},\n    {\"text\":\"Investigar impacto\",\"type\":\"investigate\"},\n    {\"text\":\"Falar com afetados\",\"type\":\"social\"}\n  ],\n  \"delta_updates\": {\n    \"hp_change\": 0,\n    \"xp_awarded\": NÃšMERO_ENTRE_${xpMin}_E_${xpMax},\n    \"gold_change\": 0,\n    \"inventory\": {\"add\":[],\"remove\":[]},\n    \"active_npcs_update\": {\"add\":[],\"remove\":[]},\n    \"location_update\": \"\",\n    \"in_combat\": false,\n    \"combat_target\": null,\n    \"status_effects_update\": {\"add\":[],\"remove\":[]},\n    \"world_flags_update\": {\"set\":{},\"delete\":[]}\n  },\n  \"metadata\": {\"consequence_type\":\"reputation|location|npc|resource|quest\",\"severity\":\"minor|moderate|major|catastrophic\"}\n}`,\n  },\n\n  commerce: {\n    persona: `VocÃª Ã© O MERCADOR de ${sys.name}. Gerencie transaÃ§Ãµes com fair play: preÃ§os realistas, NPCs com interesses prÃ³prios. O ouro tem peso real â€” comprar exige gastar, vender gera menos do que o valor do item.`,\n    instructions: `MODO: COMMERCE\n${commonContext}\nAÃ‡ÃƒO: \"${lastPlayerMsg}\"\n${MASTER_RULES}\n\nREGRAS DE ECONOMIA:\nâ€¢ VENDER: Jogador recebe 40-60% do \"value\" do item (NPCs nÃ£o pagam preÃ§o cheio).\nâ€¢ COMPRAR: Jogador paga o \"value\" cheio do item + margem do vendedor (10-30%).\nâ€¢ NEGOCIAR: Teste de ${sys.skills[2]} vs DC ${13 + diff.diffMod} pode melhorar o preÃ§o em atÃ© 20%.\nâ€¢ Ouro atual: ${gold}g â€” NÃƒO permita compras que deixem gold negativo.\nâ€¢ Itens Ãºnicos (rarity: rare/legendary) tÃªm preÃ§o 2-3Ã— o value base.\nâ€¢ DESCANSO em taverna custa ouro: nÃ­vel ${level} Ã— ${Math.max(2, Math.round(3 * diff.goldMult))}g por noite.\nâ€¢ \"type\" sÃ³ aceita: consumable | weapon | armor | misc\nâ€¢ Itens equipÃ¡veis comprados DEVEM ter em effect_data: is_equippable, equip_slot, icon, stats\nâ€¢ Itens nÃ£o equipÃ¡veis: \"is_equippable\": false\n\nITENS DISPONÃVEIS PARA COMPRAR (gere 3-5 baseados no local e nÃ­vel):\n  Estilo: ${sys.itemStyle} | NÃ­vel: ${level} | Local: ${currentLocation}\n\nINVENTÃRIO DO JOGADOR (para vender):\n${inventoryContext}\n\nSCHEMA JSON:\n{\n  \"narrative\": \"Cena da transaÃ§Ã£o com personalidade do vendedor.\",\n  \"shop_inventory\": [\n    {\"name\":\"\",\"description\":\"\",\"type\":\"consumable|weapon|armor|misc\",\"price\":0,\"value\":0,\"quantity\":1}\n  ],\n  \"choices\": [\n    {\"text\":\"Comprar [item]\",\"type\":\"buy\",\"item_name\":\"\",\"cost\":0},\n    {\"text\":\"Vender [item do inventÃ¡rio]\",\"type\":\"sell\",\"item_name\":\"\",\"value\":0},\n    {\"text\":\"Negociar preÃ§o\",\"type\":\"social\",\"skillCheck\":\"${sys.skills[2]}\",\"difficulty\":${13 + diff.diffMod},\"diceType\":\"d20\"},\n    {\"text\":\"Ir embora\",\"type\":\"action\"}\n  ],\n  \"delta_updates\": {\n    \"hp_change\": 0,\n    \"xp_awarded\": NÃšMERO_ENTRE_${xpMin}_E_${xpMax},\n    \"gold_change\": POSITIVO_se_vendeu_NEGATIVO_se_comprou,\n    \"inventory\": {\"add\":[],\"remove\":[]},\n    \"active_npcs_update\": {\"add\":[],\"remove\":[]}\n  },\n  \"metadata\": {\n    \"transaction_type\": \"buy|sell|negotiate|browse\",\n    \"merchant_name\": \"Nome do vendedor\",\n    \"merchant_mood\": \"amigÃ¡vel|neutro|desconfiado|hostil\"\n  }\n}`,\n  },\n}; // fim de prompts\n\n// =========================================\n// 13. OVERRIDES DE MODO\n// =========================================\nif (inCombatDB && detectedMode === \"narrative\") {\n  detectedMode = \"combat\";\n}\n\nif (detectedMode !== \"combat\" && experience >= nextLevelXp) {\n  detectedMode = \"levelup\";\n}\n\nif (detectedMode === \"narrative\") {\n  const actionLower = lastPlayerMsg.toLowerCase();\n  if (actionLower.match(/vend|compr|loja|mercad|taverna.*pag|negoci|quanto custa|preÃ§o/)) {\n    detectedMode = \"commerce\";\n  }\n}\n\n// =========================================\n// 14. VALIDADOR DE JSON DA IA\n// =========================================\nconst JSON_VALIDATOR = {\n  required: [\"narrative\", \"choices\", \"delta_updates\"],\n  types: {\n    narrative:                          \"string\",\n    choices:                            \"array\",\n    \"delta_updates.hp_change\":          \"number\",\n    \"delta_updates.xp_awarded\":         \"number\",\n    \"delta_updates.gold_change\":        \"number\",\n    \"delta_updates.inventory.add\":      \"array\",\n    \"delta_updates.inventory.remove\":   \"array\",\n    \"delta_updates.active_npcs_update.add\":    \"array\",\n    \"delta_updates.active_npcs_update.remove\": \"array\",\n  },\n  bounds: {\n    \"delta_updates.hp_change\":   { min: -9999, max: 9999 },\n    \"delta_updates.xp_awarded\":  { min: 0,     max: xpMax * 2 },\n    \"delta_updates.gold_change\": { min: -9999, max: 9999 },\n  },\n  defaults: {\n    \"delta_updates.hp_change\":              0,\n    \"delta_updates.xp_awarded\":             xpMin,\n    \"delta_updates.gold_change\":            0,\n    \"delta_updates.inventory\":              { add: [], remove: [] },\n    \"delta_updates.active_npcs_update\":     { add: [], remove: [] },\n    \"delta_updates.location_update\":        \"\",\n    \"delta_updates.active_quests_update\":   { add: [], remove: [] },\n    metadata: {},\n  },\n  fallback_narrative: `O Mestre hesita por um momento... e entÃ£o a cena continua.`,\n  fallback_choices: [\n    { text: \"Continuar\",  type: \"action\" },\n    { text: \"Aguardar\",   type: \"stealth\" },\n    { text: \"Investigar\", type: \"investigate\" },\n  ],\n};\n\n// =========================================\n// 15. SELEÃ‡ÃƒO COM FALLBACK SEGURO\n// =========================================\nconst selected = prompts[detectedMode] || prompts.narrative;\n\n// =========================================\n// 16. RETORNO FINAL\n// FIX: current_npcs adicionado ao parserContext\n// =========================================\nconst parserContext = {\n  story_id:       String(storyData.story_id),\n  system_id:      systemId,\n  difficulty:     difficulty,\n  genres:         genres,\n  character_name: charName,\n  detected_mode:  detectedMode,\n\n  original_hp_current: hpCurrent,\n  original_hp_max:     hpMax,\n  original_level:      level,\n  original_xp:         experience,\n  original_gold:       gold,\n  xp_for_next_level:   nextLevelXp,\n\n  // â”€â”€ FIX: array atual de NPCs para o parser aplicar delta â”€â”€\n  current_npcs: activeNPCs,\n\n  xp_range:       { min: xpMin, max: xpMax },\n  gold_delta_base: goldDeltaBase,\n  diff_multipliers: {\n    dmg:  diff.dmgMult,\n    loot: diff.lootMult,\n    xp:   diff.xpMult,\n    gold: diff.goldMult,\n  },\n\n  in_combat_db:     inCombatDB,\n  combat_target_db: combatTargetDB,\n\n  status_effects_after_turn: combatResult?.statusAfterTurn ?? remainingEffects,\n  effects_expired:           combatResult?.expiringEffects ?? expiringEffects,\n\n  json_validator: JSON_VALIDATOR,\n\n  combat_calculated: combatResult\n    ? {\n        player_damage_taken: combatResult.totalPlayerDamageTaken,\n        player_hp_after:     combatResult.playerHpAfter,\n        total_hp_delta:      combatResult.totalHpDelta,\n        enemy_damage_dealt:  combatResult.player.damage,\n        enemy_hp_after:      combatResult.enemyHpAfter,\n        target_died:         combatResult.targetDied,\n        all_enemies_dead:    combatResult.allEnemiesDead,\n        dead_npcs:           combatResult.deadNPCs,\n        gold_dropped:        combatResult.goldDropped,\n        updated_npcs:        combatResult.updatedNPCs,\n        enemy_turns_summary: combatResult.enemyTurns,\n        new_in_combat: !(combatResult.allEnemiesDead || combatResult.playerHpAfter <= 0),\n        new_combat_target:\n          combatResult.allEnemiesDead || combatResult.targetDied ? null : targetName,\n      }\n    : null,\n};\n\nreturn {\n  json: {\n    ai_request: {\n      model: \"mistral-large-latest\",\n      messages: [\n        { role: \"system\", content: selected.persona },\n        { role: \"user\",   content: selected.instructions },\n      ],\n      temperature:\n        detectedMode === \"combat\"  ? 0.45 :\n        detectedMode === \"levelup\" ? 0.85 : 0.72,\n      max_tokens: detectedMode === \"narrative\" ? 4000 : 3000,\n      response_format: { type: \"json_object\" },\n      metadata: {\n        story_id:       String(storyData.story_id),\n        prompt_version: \"6.1\",\n        detected_mode:  String(detectedMode),\n        character_name: String(charName),\n        system_id:      String(systemId),\n        difficulty:     String(difficulty),\n        level:          String(level),\n      },\n    },\n    parser_context: parserContext,\n  },\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1424,-656],"id":"1d4e13a7-c86a-4792-bcea-05541bee806b","name":"Code in JavaScript5"},{"parameters":{"method":"POST","url":"https://api.mistral.ai/v1/chat/completions","authentication":"predefinedCredentialType","nodeCredentialType":"mistralCloudApi","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($json.ai_request) }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-1264,-656],"id":"d8bc0f7b-2c56-48bd-8992-954295420ae2","name":"HTTP Request10","credentials":{"mistralCloudApi":{"id":"HbOWghtcXEf7jxxj","name":"Mistral Cloud account"},"openRouterApi":{"id":"mCdp8OcIGuBAlyxd","name":"OpenRouter account"}}},{"parameters":{"jsCode":"// =========================================\n// PARSER PÃ“S-IA â€” V6.1\n// LÃª o response do Mistral + parser_context do Mestre\n// Sanitiza, valida, aplica combat_calculated\n// e monta os updates exatos para cada tabela do banco\n//\n// V6.1: equipment gerenciado pelo front-end\n//       itens equipÃ¡veis carregam em effect_data:\n//       { is_equippable, equip_slot, icon, damage|armor }\n// FIX: current_npcs lido de ctx (nÃ£o mais linha solta invÃ¡lida)\n// FIX: NPCs adicionados recebem HP automÃ¡tico baseado no nÃ­vel\n// =========================================\n\n// =========================================\n// 1. FONTES DE DADOS\n// =========================================\nconst aiRaw = $input.first().json;\nconst ctx   = $('Code in JavaScript5').first().json.parser_context;\n\nconst storyId   = ctx.story_id;\nconst mode      = ctx.detected_mode;\nconst validator = ctx.json_validator;\nconst calc      = ctx.combat_calculated;\n\n// =========================================\n// 2. PARSE E SANITIZAÃ‡ÃƒO\n// =========================================\nlet rawText = \"\";\ntry { rawText = aiRaw.choices[0].message.content || \"\"; } catch(e) {}\n\nlet aiResponse = null;\ntry {\n    const cleaned = rawText.replace(/```json/gi, \"\").replace(/```/g, \"\").trim();\n    aiResponse = JSON.parse(cleaned);\n} catch(e) {\n    console.log(\"âš ï¸ JSON da IA invÃ¡lido, usando fallback. Erro: \" + e.message);\n    aiResponse = {\n        narrative:     validator.fallback_narrative,\n        choices:       validator.fallback_choices,\n        delta_updates: {}\n    };\n}\n\nconst du = aiResponse.delta_updates || {};\n\nfunction safeGet(obj, path, expectedType, defaultVal) {\n    const parts = path.split(\".\");\n    let cursor  = obj;\n    for (const p of parts) {\n        if (cursor == null || typeof cursor !== \"object\") return defaultVal;\n        cursor = cursor[p];\n    }\n    if (cursor == null) return defaultVal;\n    if (expectedType === \"number\")  { const n = Number(cursor); return isNaN(n) ? defaultVal : n; }\n    if (expectedType === \"string\")  return typeof cursor === \"string\"  ? cursor : String(cursor);\n    if (expectedType === \"boolean\") return typeof cursor === \"boolean\" ? cursor : Boolean(cursor);\n    if (expectedType === \"array\")   return Array.isArray(cursor) ? cursor : defaultVal;\n    return cursor;\n}\n\nfunction clip(n, min, max) { return Math.max(min, Math.min(max, n)); }\n\n// =========================================\n// 2d. EXTRAIR CAMPOS\n// =========================================\nconst narrative = safeGet(aiResponse, \"narrative\", \"string\", validator.fallback_narrative);\nconst choices   = safeGet(aiResponse, \"choices\",   \"array\",  validator.fallback_choices);\n\n// Renomeia campos camelCase â†’ snake_case para o banco\nconst choicesMapped = choices.map(c => ({\n    story_id:    storyId,\n    text:        c.text,\n    type:        c.type,\n    skill_check: c.skillCheck ?? c.skill_check ?? null,\n    difficulty:  c.difficulty ?? null,\n    dice_type:   c.diceType   ?? c.dice_type   ?? null,\n}));\n\nlet hpChange   = clip(safeGet(du, \"hp_change\",   \"number\", 0), validator.bounds[\"delta_updates.hp_change\"].min,   validator.bounds[\"delta_updates.hp_change\"].max);\nlet xpAwarded  = clip(safeGet(du, \"xp_awarded\",  \"number\", 0), validator.bounds[\"delta_updates.xp_awarded\"].min,  validator.bounds[\"delta_updates.xp_awarded\"].max);\nlet goldChange = clip(safeGet(du, \"gold_change\", \"number\", 0), validator.bounds[\"delta_updates.gold_change\"].min, validator.bounds[\"delta_updates.gold_change\"].max);\n\nconst invAdd    = safeGet(du, \"inventory.add\",    \"array\", []);\nconst invRemove = safeGet(du, \"inventory.remove\", \"array\", []);\n\nconst npcsAdd    = safeGet(du, \"active_npcs_update.add\",    \"array\", []);\nconst npcsRemove = safeGet(du, \"active_npcs_update.remove\", \"array\", []);\n\nconst locationUpdate = safeGet(du, \"location_update\",             \"string\", \"\");\nconst questsAdd      = safeGet(du, \"active_quests_update.add\",    \"array\",  []);\nconst questsRemove   = safeGet(du, \"active_quests_update.remove\", \"array\",  []);\n\nconst worldFlagsSet    = (du.world_flags_update?.set    ?? {});\nconst worldFlagsDelete = safeGet(du, \"world_flags_update.delete\", \"array\", []);\n\nconst statusEffectsAdd    = safeGet(du, \"status_effects_update.add\",    \"array\", []);\nconst statusEffectsRemove = safeGet(du, \"status_effects_update.remove\", \"array\", []);\n\nconst inCombatAI     = safeGet(du, \"in_combat\",     \"boolean\", false);\nconst combatTargetAI = safeGet(du, \"combat_target\", \"string\",  \"\");\n\n// =========================================\n// 3. APLICAR COMBAT_CALCULATED\n// =========================================\nlet finalHpChange     = hpChange;\nlet finalGoldChange   = goldChange;\nlet finalInCombat     = inCombatAI;\nlet finalCombatTarget = combatTargetAI || null;\nlet finalNpcsRemove   = [...npcsRemove];\nlet finalUpdatedNpcs  = null;\nlet finalStatusAfter  = ctx.status_effects_after_turn;\n\nif (calc) {\n    finalHpChange     = calc.total_hp_delta;\n    finalGoldChange   = calc.gold_dropped ?? 0;\n    finalInCombat     = calc.new_in_combat;\n    finalCombatTarget = calc.new_combat_target ?? null;\n\n    if (calc.dead_npcs?.length) {\n        const existing = new Set(finalNpcsRemove);\n        calc.dead_npcs.forEach(n => existing.add(n));\n        finalNpcsRemove = Array.from(existing);\n    }\n    finalUpdatedNpcs = calc.updated_npcs;\n}\n\n// =========================================\n// 4. CALCULAR NOVOS VALORES\n// =========================================\nconst origHp    = ctx.original_hp_current;\nconst origHpMax = ctx.original_hp_max;\nconst origXp    = ctx.original_xp;\nconst origGold  = ctx.original_gold;\nconst origLevel = ctx.original_level;\nconst xpForNext = ctx.xp_for_next_level;\n\nconst newHpCurrent = Math.max(0, Math.min(origHpMax, origHp + finalHpChange));\nconst newXp        = Math.max(origXp, origXp + xpAwarded);\nconst newGold      = Math.max(0, origGold + finalGoldChange);\nconst shouldLevel  = newXp >= xpForNext && mode !== \"levelup\";\n\n// =========================================\n// 5. MONTAR UPDATES\n// =========================================\n\n// â”€â”€ 5a. stories â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst storiesUpdate = {\n    hp_current:     newHpCurrent,\n    experience:     newXp,\n    gold:           newGold,\n    in_combat:      finalInCombat,\n    combat_target:  finalCombatTarget,\n    status_effects: buildNewStatusEffects(finalStatusAfter, statusEffectsAdd, statusEffectsRemove),\n};\n\nif (locationUpdate && locationUpdate.trim() !== \"\") {\n    storiesUpdate.current_location = locationUpdate.trim();\n}\n\nif (finalUpdatedNpcs) {\n    // Caso 1: lista completa atualizada vinda do combat calc (jÃ¡ tem HP encoded)\n    storiesUpdate.active_npcs = finalUpdatedNpcs.filter(\n        npc => !finalNpcsRemove.includes(npc.replace(/\\s*\\[HP:\\d+\\/\\d+\\]/, \"\").trim())\n    );\n} else if (npcsAdd.length || finalNpcsRemove.length) {\n    // Caso 2: aplica delta (add/remove) no array atual\n    // current_npcs vem do parserContext (Mestre V6.1)\n    const currentNPCs = Array.isArray(ctx.current_npcs) ? ctx.current_npcs : [];\n\n    // Remove os NPCs marcados para remoÃ§Ã£o (compara nome sem HP)\n    const afterRemove = currentNPCs.filter(npc => {\n        const cleanName = npc.replace(/\\s*\\[HP:\\d+\\/\\d+\\]/, \"\").trim();\n        return !finalNpcsRemove.includes(cleanName);\n    });\n\n    // Adiciona novos NPCs com HP gerado automaticamente\n    const afterAdd = [\n        ...afterRemove,\n        ...npcsAdd\n            .filter(newNpc => {\n                // Evita duplicatas (compara nome limpo)\n                const cleanNew = newNpc.replace(/\\s*\\[HP:\\d+\\/\\d+\\]/, \"\").trim();\n                return !afterRemove.some(existing =>\n                    existing.replace(/\\s*\\[HP:\\d+\\/\\d+\\]/, \"\").trim() === cleanNew\n                );\n            })\n            .map(newNpc => {\n                // Se jÃ¡ vier com HP encoded, mantÃ©m como estÃ¡\n                if (/\\[HP:\\d+\\/\\d+\\]/.test(newNpc)) return newNpc;\n                // Gera HP baseado no nÃ­vel: base 10 + (nÃ­vel Ã— 5) + variaÃ§Ã£o 1d6-3\n                const baseHp = 10 + (origLevel * 5);\n                const roll   = Math.floor(Math.random() * 6) + 1; // 1d6\n                const hp     = Math.max(5, baseHp + roll - 3);\n                return `${newNpc} [HP:${hp}/${hp}]`;\n            })\n    ];\n\n    storiesUpdate.active_npcs = afterAdd;\n}\n\nif (questsAdd.length || questsRemove.length) {\n    storiesUpdate.active_quests_delta = { add: questsAdd, remove: questsRemove };\n}\n\n// â”€â”€ 5b. messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst messageInsert = {\n    story_id:         storyId,\n    sender:           \"narrator\",\n    content:          narrative,\n    choices:    choicesMapped,  // â† era choices\n    mode:             mode,\n    combat_log:       mode === \"combat\"   ? (aiResponse.combat_log        ?? null) : null,\n    level_up_choices: mode === \"levelup\"  ? (aiResponse.level_up_choices  ?? null) : null,\n    shop_inventory:   mode === \"commerce\" ? (aiResponse.shop_inventory    ?? null) : null,\n};\n\n// â”€â”€ 5c. items â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst VALID_INV_TYPES   = [\"consumable\", \"weapon\", \"armor\", \"misc\"];\nconst INV_TYPE_FALLBACK = {\n    equipment:  \"weapon\",\n    potion:     \"consumable\",\n    food:       \"consumable\",\n    quest_item: \"misc\",\n    tool:       \"misc\",\n};\n\nconst itemsToAdd = invAdd.map(item => {\n    let safeType = (item.type || \"misc\").toLowerCase();\n    if (!VALID_INV_TYPES.includes(safeType)) safeType = INV_TYPE_FALLBACK[safeType] || \"misc\";\n\n    const effectData = item.effect_data || {};\n    if ((safeType === \"weapon\" || safeType === \"armor\") && effectData.is_equippable === undefined) {\n        effectData.is_equippable = true;\n        if (!effectData.equip_slot) effectData.equip_slot = safeType === \"weapon\" ? \"main_hand\" : \"body\";\n        if (!effectData.icon)       effectData.icon       = safeType === \"weapon\" ? \"âš”ï¸\" : \"ðŸ›¡ï¸\";\n    }\n    if (safeType === \"consumable\" || safeType === \"misc\") {\n        effectData.is_equippable = false;\n    }\n\n    return {\n        story_id:    storyId,\n        name:        item.name        || \"Item desconhecido\",\n        description: item.description || \"\",\n        quantity:    Math.max(1, parseInt(item.quantity) || 1),\n        type:        safeType,\n        effect_data: effectData,\n        value:       parseInt(item.value) || 0,\n    };\n});\n\nconst itemNamesToRemove = invRemove\n    .map(i => typeof i === \"string\" ? i : i.name)\n    .filter(Boolean);\n\n// â”€â”€ 5d. world_flags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst worldFlagsToUpsert = Object.entries(worldFlagsSet)\n    .filter(([, value]) => value !== null && value !== undefined)\n    .map(([key, value]) => ({\n        story_id:   storyId,\n        flag_key:   key,\n        flag_value: value ?? false,\n    }));\nconst worldFlagsToDelete = worldFlagsDelete.filter(Boolean);\n\n// â”€â”€ 5e. level up â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst levelUpPending = shouldLevel ? {\n    story_id:  storyId,\n    new_level: origLevel + 1,\n    xp_over:   newXp - xpForNext,\n} : null;\n\n// =========================================\n// 6. HELPER status_effects\n// =========================================\nfunction buildNewStatusEffects(afterTurn, toAdd, toRemoveIds) {\n    let result = Array.isArray(afterTurn) ? [...afterTurn] : [];\n    if (Array.isArray(toAdd)) {\n        toAdd.forEach(ef => {\n            if (ef.id && !result.find(e => e.id === ef.id)) result.push(ef);\n        });\n    }\n    if (Array.isArray(toRemoveIds)) {\n        result = result.filter(e => !toRemoveIds.includes(e.id));\n    }\n    return result;\n}\n\n// =========================================\n// 7. RETORNO\n// =========================================\nreturn {\n    json: {\n        story_id:      storyId,\n        detected_mode: mode,\n\n        // â”€â”€ Resposta da IA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        ai_response: {\n            narrative,\n            choices:          choicesMapped,\n            combat_log:       messageInsert.combat_log,\n            level_up_choices: messageInsert.level_up_choices,\n            shop_inventory:   messageInsert.shop_inventory,\n            metadata:         aiResponse.metadata ?? {},\n        },\n\n        // â”€â”€ PATCH stories â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        stories_update: storiesUpdate,\n\n        // â”€â”€ POST messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        message_insert: messageInsert,\n\n        // â”€â”€ POST items â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        items_to_add: itemsToAdd,\n\n        // â”€â”€ DELETE items â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        items_to_remove: itemNamesToRemove,\n\n        // â”€â”€ UPSERT world_flags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        world_flags_upsert: worldFlagsToUpsert,\n\n        // â”€â”€ DELETE world_flags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        world_flags_delete: worldFlagsToDelete,\n\n        // â”€â”€ Level Up trigger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        level_up_pending: levelUpPending,\n\n        // â”€â”€ Debug â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        summary: {\n            hp:                   `${origHp} â†’ ${newHpCurrent}/${origHpMax}  (Î”${finalHpChange})`,\n            xp:                   `${origXp} â†’ ${newXp}  (+${xpAwarded})`,\n            gold:                 `${origGold} â†’ ${newGold}  (Î”${finalGoldChange})`,\n            in_combat:            finalInCombat,\n            combat_target:        finalCombatTarget,\n            items_added:          itemsToAdd.length,\n            items_removed:        itemNamesToRemove.length,\n            npcs_added:           npcsAdd.length,\n            npcs_removed:         finalNpcsRemove,\n            flags_set:            Object.keys(worldFlagsSet).length,\n            flags_deleted:        worldFlagsToDelete.length,\n            level_up:             shouldLevel,\n            status_effects_count: storiesUpdate.status_effects.length,\n        },\n    },\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1104,-656],"id":"80506223-3e6d-4b1e-ae13-77b16354a79d","name":"Code in JavaScript6"},{"parameters":{"method":"POST","url":"https://jmjezldxisifcdjacwnb.supabase.co/rest/v1/world_flags","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"return=minimal"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.choices }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-2080,-400],"id":"ae9d7ca5-4a25-41e8-a007-c1695dda333f","name":"HTTP Request11","credentials":{"supabaseApi":{"id":"3ssV9qtsZUAklVtZ","name":"Supabase account 2"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"85b1c338-38cc-4c13-a1c8-ea08c32e04d4","leftValue":"={{$json.world_flags.length}}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-2272,-384],"id":"e4a47154-ffde-49f2-a0c9-e422590df5f3","name":"If"},{"parameters":{"method":"PATCH","url":"https://jmjezldxisifcdjacwnb.supabase.co/rest/v1/stories","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendQuery":true,"specifyQuery":"json","jsonQuery":"={\n  \"id\": \"eq.{{ $json.story_id }}\"\n}","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.stories_update }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-880,-1040],"id":"b6f4f0b1-5ce9-4a0a-a6ce-636b24e9dfa8","name":"HTTP Request23","credentials":{"supabaseApi":{"id":"3ssV9qtsZUAklVtZ","name":"Supabase account 2"}}},{"parameters":{"method":"POST","url":"https://jmjezldxisifcdjacwnb.supabase.co/rest/v1/messages","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"return=minimal"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{\n{\n  \"story_id\":$json.message_insert.story_id,\n  \"sender\":$json.message_insert.sender,\n  \"content\":$json.message_insert.content\n}\n}}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-880,-768],"id":"e61fba3a-4c6f-4a9e-bee3-68300964c204","name":"HTTP Request12","credentials":{"supabaseApi":{"id":"3ssV9qtsZUAklVtZ","name":"Supabase account 2"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"1c4b3e26-f6ad-472d-9fe3-9630d6cbe489","leftValue":"={{ $json.items_to_add.length }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-880,-624],"id":"9b8a03e2-dbfe-4128-9a3e-8c56f5c94219","name":"If1"},{"parameters":{"method":"POST","url":"https://jmjezldxisifcdjacwnb.supabase.co/rest/v1/items","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"return=minimal"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.items_to_add }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-720,-624],"id":"a3c92d6a-55b6-4d26-bfd8-6d12aef8ed70","name":"HTTP Request13","credentials":{"supabaseApi":{"id":"3ssV9qtsZUAklVtZ","name":"Supabase account 2"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"1c4b3e26-f6ad-472d-9fe3-9630d6cbe489","leftValue":"={{ $json.items_to_remove.length }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-880,-464],"id":"a5d1b78e-c0fb-4485-85e8-b02d7e2ca20f","name":"If2"},{"parameters":{"method":"DELETE","url":"https://jmjezldxisifcdjacwnb.supabase.co/rest/v1/items","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"return=minimal"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"story_id\": \"{{ $json.story_id }}\",\n  \"names\": {{ $json.items_to_remove }}\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-720,-464],"id":"8b980961-2ca8-464a-81a4-44a934b395c1","name":"HTTP Request14","credentials":{"supabaseApi":{"id":"3ssV9qtsZUAklVtZ","name":"Supabase account 2"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"1c4b3e26-f6ad-472d-9fe3-9630d6cbe489","leftValue":"={{ $json.world_flags_upsert.length }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-880,-320],"id":"a70ce6a0-8980-457b-9540-7a42cbac9b21","name":"If3"},{"parameters":{"method":"POST","url":"https://jmjezldxisifcdjacwnb.supabase.co/rest/v1/world_flags","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"resolution=merge-duplicates"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.world_flags_upsert }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-720,-320],"id":"35dca8a3-ddeb-42b6-b22d-afdca865f6d9","name":"HTTP Request15","credentials":{"supabaseApi":{"id":"3ssV9qtsZUAklVtZ","name":"Supabase account 2"}}},{"parameters":{"method":"DELETE","url":"https://jmjezldxisifcdjacwnb.supabase.co/rest/v1/world_flags","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"return=minimal"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"story_id\": \"{{ $json.story_id }}\",\n  \"flag_keys\": {{ $json.world_flags_delete }}\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-720,-160],"id":"ade6a97a-9ff9-4a91-a070-165e37222fe4","name":"HTTP Request16","credentials":{"supabaseApi":{"id":"3ssV9qtsZUAklVtZ","name":"Supabase account 2"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"1c4b3e26-f6ad-472d-9fe3-9630d6cbe489","leftValue":"={{ $json.world_flags_delete.length }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-880,-160],"id":"a2d51ee5-d025-42e9-9a0f-6995a27eadc1","name":"If4"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"1c4b3e26-f6ad-472d-9fe3-9630d6cbe489","leftValue":"={{ $json.level_up_pending }}","rightValue":0,"operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-880,-16],"id":"c9f0f0fc-f448-4d3d-b3de-7747c7dfd020","name":"If5"},{"parameters":{"method":"PATCH","url":"https://jmjezldxisifcdjacwnb.supabase.co/rest/v1/stories","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendQuery":true,"specifyQuery":"json","jsonQuery":"={\n  \"id\": \"eq.{{ $json.level_up_pending.story_id }}\"\n}","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.level_up_pending }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-720,-16],"id":"6ebfc1c7-6bb9-4046-99e1-639e1dc13b0e","name":"HTTP Request24","credentials":{"supabaseApi":{"id":"3ssV9qtsZUAklVtZ","name":"Supabase account 2"}}},{"parameters":{"method":"POST","url":"https://jmjezldxisifcdjacwnb.supabase.co/rest/v1/choices","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"return=minimal"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.ai_response.choices }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.4,"position":[-880,-912],"id":"f307ad1a-15bf-4eaa-b9f1-0c8a28bb3612","name":"HTTP Request17","credentials":{"supabaseApi":{"id":"3ssV9qtsZUAklVtZ","name":"Supabase account 2"}}}],"connections":{"HTTP Request1":{"main":[[{"node":"Code in JavaScript1","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Code in JavaScript","type":"main","index":0}]]},"Code in JavaScript":{"main":[[{"node":"HTTP Request1","type":"main","index":0}]]},"Code in JavaScript1":{"main":[[{"node":"HTTP Request","type":"main","index":0},{"node":"HTTP Request2","type":"main","index":0},{"node":"HTTP Request3","type":"main","index":0},{"node":"HTTP Request4","type":"main","index":0},{"node":"HTTP Request22","type":"main","index":0},{"node":"If","type":"main","index":0}]]},"HTTP Request":{"main":[[]]},"HTTP Request2":{"main":[[]]},"Webhook1":{"main":[[{"node":"HTTP Request5","type":"main","index":0}]]},"HTTP Request5":{"main":[[{"node":"Code in JavaScript2","type":"main","index":0}]]},"Code in JavaScript2":{"main":[[{"node":"HTTP Request6","type":"main","index":0}]]},"HTTP Request6":{"main":[[{"node":"Code in JavaScript3","type":"main","index":0}]]},"Code in JavaScript3":{"main":[[{"node":"HTTP Request7","type":"main","index":0}]]},"Webhook2":{"main":[[{"node":"HTTP Request8","type":"main","index":0}]]},"HTTP Request8":{"main":[[{"node":"Code in JavaScript4","type":"main","index":0}]]},"Code in JavaScript4":{"main":[[{"node":"HTTP Request9","type":"main","index":0}]]},"HTTP Request9":{"main":[[{"node":"Code in JavaScript5","type":"main","index":0}]]},"Code in JavaScript5":{"main":[[{"node":"HTTP Request10","type":"main","index":0}]]},"HTTP Request10":{"main":[[{"node":"Code in JavaScript6","type":"main","index":0}]]},"HTTP Request11":{"main":[[]]},"If":{"main":[[{"node":"HTTP Request11","type":"main","index":0}]]},"Code in JavaScript6":{"main":[[{"node":"HTTP Request23","type":"main","index":0},{"node":"HTTP Request12","type":"main","index":0},{"node":"If1","type":"main","index":0},{"node":"If2","type":"main","index":0},{"node":"If3","type":"main","index":0},{"node":"If4","type":"main","index":0},{"node":"HTTP Request17","type":"main","index":0}]]},"HTTP Request12":{"main":[[]]},"If1":{"main":[[{"node":"HTTP Request13","type":"main","index":0}]]},"If2":{"main":[[{"node":"HTTP Request14","type":"main","index":0}]]},"If3":{"main":[[{"node":"HTTP Request15","type":"main","index":0}]]},"If4":{"main":[[{"node":"HTTP Request16","type":"main","index":0}]]},"If5":{"main":[[{"node":"HTTP Request24","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","binaryMode":"separate","availableInMCP":false},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"localhost:5678","connection":"keep-alive","content-type":"application/json","api-rpg":"1a989b28-6d5d-42ac-b66a-c06368651685","accept":"*/*","accept-language":"*","sec-fetch-mode":"cors","user-agent":"node","accept-encoding":"gzip, deflate","content-length":"222"},"params":{},"query":{},"body":{"story_id":"1ccc7646-e3ce-4b19-b8c7-bc2884020def","character_name":"teste","system":"vampire","class_name":"Tremere (Feiticeiro)","background":"teste","genres":["High Fantasy","Terror CÃ³smico"],"difficulty":"impossible"},"webhookUrl":"http://localhost:5678/webhook/start-game","executionMode":"production"},"pairedItem":{"item":0}}],"Webhook2":[{"json":{"headers":{"host":"localhost:5678","connection":"keep-alive","content-type":"application/json","api-rpg":"1a989b28-6d5d-42ac-b66a-c06368651685","accept":"*/*","accept-language":"*","sec-fetch-mode":"cors","user-agent":"node","accept-encoding":"gzip, deflate","content-length":"327"},"params":{},"query":{},"body":{"story_id":"28975afb-e4f1-4959-a586-14d57b500b03","player_message":{"content":"Enfrentar os guardas que se aproximam com magia, tentando abrir caminho Ã  forÃ§a.","type":"action","skill_check":"Destreza","difficulty":22,"dice_type":"d20","roll_result":{"total":8,"roll":8,"difficulty":22,"success":false,"is_critical":false}}},"webhookUrl":"http://localhost:5678/webhook/storie","executionMode":"production"},"pairedItem":{"item":0}}]},"versionId":"a138ebff-e98d-4662-b5be-539d99910e1e","activeVersionId":"a138ebff-e98d-4662-b5be-539d99910e1e","versionCounter":1384,"triggerCount":3,"tags":[],"shared":[{"updatedAt":"2026-02-12T23:37:50.693Z","createdAt":"2026-02-12T23:37:50.693Z","role":"workflow:owner","workflowId":"NTeI9lc3Cy5QgHP9","projectId":"xNzfUbK30939khXb","project":{"updatedAt":"2026-02-12T23:20:05.150Z","createdAt":"2026-02-12T23:16:10.000Z","id":"xNzfUbK30939khXb","name":"Gabriel Cocovilo <gabrielcocovilo25@gmail.com>","type":"personal","icon":null,"description":null,"creatorId":"28e24eb4-bc65-4b50-951b-e468d81c4a24"}}]}]